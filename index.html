<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Synthwave</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Share Tech Mono',monospace;color:#fff;cursor:none}
#cur{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;z-index:9999;mix-blend-mode:screen;transition:background 2s}
canvas{position:fixed;top:0;left:0;width:100%;height:100%}
#c0{z-index:1}#c1{z-index:2}#c2{z-index:3}#c3{z-index:4;pointer-events:none}
#login{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000}
#login::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 70% 50% at 30% 50%,rgba(6,255,216,0.07) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 75% 50%,rgba(255,0,110,0.06) 0%,transparent 60%)}
.logo{position:relative;z-index:1;font-family:'Bebas Neue',sans-serif;font-size:clamp(3rem,8vw,7rem);letter-spacing:0.15em;background:linear-gradient(135deg,#06ffd8 0%,#8338ec 50%,#ff006e 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.tagline{position:relative;z-index:1;font-size:0.7rem;letter-spacing:0.4em;color:rgba(255,255,255,0.3);margin:0.8rem 0 4rem;text-transform:uppercase}
.btn{position:relative;z-index:1;padding:1rem 3rem;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:0.3em;color:#000;background:#06ffd8;border:none;cursor:pointer;clip-path:polygon(10px 0%,100% 0%,calc(100% - 10px) 100%,0% 100%);transition:all 0.2s}
.btn:hover{background:#fff;box-shadow:0 0 50px rgba(6,255,216,0.5);transform:scale(1.04)}
#loginErr{position:relative;z-index:1;color:#ff006e;font-size:0.62rem;letter-spacing:0.15em;margin-top:1.2rem;max-width:420px;text-align:center;display:none}
.scanlines{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.025) 2px,rgba(0,0,0,0.025) 4px);pointer-events:none;z-index:100}
#ui{position:fixed;z-index:80;inset:0;pointer-events:none;display:none}
#trackName{position:absolute;bottom:2.5rem;left:2.5rem;max-width:50vw;font-family:'Bebas Neue',sans-serif;font-size:clamp(1.2rem,3vw,2.2rem);letter-spacing:0.08em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 40px currentColor;transition:color 3s}
#artistName{position:absolute;bottom:calc(2.5rem + 2.5rem);left:2.5rem;font-size:0.68rem;letter-spacing:0.3em;color:rgba(255,255,255,0.38);text-transform:uppercase}
#sceneTag{position:absolute;top:2rem;left:2.5rem;font-size:0.62rem;letter-spacing:0.3em;color:rgba(255,255,255,0.28);text-transform:uppercase}
#albumArt{position:absolute;bottom:2.5rem;right:2.5rem;width:72px;height:72px;object-fit:cover;opacity:0.55;border:1px solid rgba(255,255,255,0.07)}
#pgWrap{position:absolute;bottom:0;left:0;right:0;height:2px;background:rgba(255,255,255,0.04)}
#pgBar{height:100%;width:0%;transition:width 1s linear}
#splash{position:fixed;inset:0;z-index:90;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity 0.8s}
#splash.show{opacity:1}
#splashScene{font-family:'Bebas Neue',sans-serif;font-size:clamp(0.7rem,1.4vw,1rem);letter-spacing:0.6em;color:rgba(255,255,255,0.35);margin-bottom:0.8rem}
#splashTrack{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.5rem,7vw,6.5rem);letter-spacing:0.06em;text-align:center;max-width:90vw;text-shadow:0 0 60px currentColor}
#splashArtist{font-size:clamp(0.8rem,1.8vw,1.1rem);letter-spacing:0.45em;color:rgba(255,255,255,0.4);margin-top:0.8rem;text-transform:uppercase}
#splashDesc{font-size:clamp(0.65rem,1.2vw,0.85rem);font-style:italic;color:rgba(255,255,255,0.22);margin-top:1.5rem;text-align:center;max-width:55vw;line-height:1.8;letter-spacing:0.05em}
#wash{position:fixed;inset:0;z-index:85;opacity:0;pointer-events:none;transition:opacity 1.2s ease}
#surpriseOverlay{position:fixed;inset:0;z-index:75;pointer-events:none;opacity:0}
#comicPanel{position:fixed;inset:0;z-index:76;pointer-events:none;display:none;font-family:'Bebas Neue',sans-serif}
#gameOverScreen{position:fixed;inset:0;z-index:76;pointer-events:none;display:none;align-items:center;justify-content:center;background:#000;font-family:'Bebas Neue',sans-serif;font-size:clamp(4rem,12vw,10rem);letter-spacing:0.2em;color:#f00;text-shadow:0 0 40px #f00}
#fsBtn{position:fixed;bottom:2.5rem;right:calc(72px + 3rem);z-index:85;background:none;border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.28);font-family:'Share Tech Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;padding:0.4rem 0.7rem;cursor:pointer;transition:all 0.2s;display:none;pointer-events:all}
#fsBtn:hover{border-color:#06ffd8;color:#06ffd8}
</style>
</head>
<body>
<div id="cur"></div>
<div class="scanlines"></div>
<canvas id="c0"></canvas><canvas id="c1"></canvas><canvas id="c2"></canvas><canvas id="c3"></canvas>
<div id="login">
  <div class="logo">SYNTHWAVE</div>
  <div class="tagline">AI Festival Visual Engine</div>
  <button id="loginBtn" class="btn">CONNECT SPOTIFY</button>
  <div id="loginErr"></div>
</div>
<div id="wash"></div>
<div id="surpriseOverlay"></div>
<div id="comicPanel"></div>
<div id="gameOverScreen">GAME OVER</div>
<div id="splash">
  <div id="splashScene"></div>
  <div id="splashTrack"></div>
  <div id="splashArtist"></div>
  <div id="splashDesc"></div>
</div>
<div id="ui">
  <div id="sceneTag">SCENE ENGINE</div>
  <div id="artistName">—</div>
  <div id="trackName">—</div>
  <img id="albumArt" src="" alt=""/>
  <div id="pgWrap"><div id="pgBar"></div></div>
</div>
<button id="fsBtn">⛶ FS</button>
<script>
// ═══ AUTH ═══
const CLIENT_ID='c4a8270f8bc6453490fc8bf4b9de5c42';
const REDIR=location.origin+'/callback';
const SCOPE='user-read-currently-playing user-read-playback-state';
function rnd(n){const a=new Uint8Array(n);crypto.getRandomValues(a);return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'').slice(0,n)}
async function sha256b64(s){const d=new TextEncoder().encode(s),h=await crypto.subtle.digest('SHA-256',d);return btoa(String.fromCharCode(...new Uint8Array(h))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'')}
const ls=(k,v)=>localStorage.setItem(k,v),lg=k=>localStorage.getItem(k);
async function doLogin(){
  const v=rnd(64),c=await sha256b64(v);
  ls('pv',v);
  console.log('[auth] login — redirect_uri='+REDIR);
  location.href='https://accounts.spotify.com/authorize?'+new URLSearchParams({client_id:CLIENT_ID,response_type:'code',redirect_uri:REDIR,scope:SCOPE,code_challenge_method:'S256',code_challenge:c,show_dialog:'true'});
}
async function exchToken(code){
  const v=lg('pv');
  console.log('[auth] exchToken code='+code.slice(0,8)+' verifier='+(v?'ok':'MISSING'));
  if(!v){showErr('Auth error: session data lost. Try again.');return null;}
  const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:CLIENT_ID,grant_type:'authorization_code',code,redirect_uri:REDIR,code_verifier:v})});
  const d=await r.json();
  console.log('[auth] token response:',r.status,Object.keys(d).join(','));
  if(d.access_token){ls('at',d.access_token);ls('ats',Date.now());if(d.refresh_token)ls('rt',d.refresh_token);localStorage.removeItem('pv');return d.access_token;}
  showErr('Spotify error: '+(d.error_description||d.error||'unknown'));
  return null;
}
async function refreshAT(){const rt=lg('rt');if(!rt)return null;const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:CLIENT_ID,grant_type:'refresh_token',refresh_token:rt})});const d=await r.json();if(d.access_token){ls('at',d.access_token);ls('ats',Date.now());return d.access_token}return null}
function getAT(){const t=lg('at'),s=parseInt(lg('ats')||0);return t&&Date.now()-s<3500000?t:null}
function showErr(msg){const el=document.getElementById('loginErr');el.textContent=msg;el.style.display='block';document.getElementById('loginBtn').textContent='TRY AGAIN';}
function logout(){ls('at','');document.getElementById('login').style.display='flex';document.getElementById('ui').style.display='none';document.getElementById('fsBtn').style.display='none';}

// ═══ CANVAS ═══
const c0=document.getElementById('c0'),x0=c0.getContext('2d');
const c1=document.getElementById('c1'),x1=c1.getContext('2d');
const c2=document.getElementById('c2'),x2=c2.getContext('2d');
const c3=document.getElementById('c3'),x3=c3.getContext('2d');
const W=()=>c0.width,H=()=>c0.height;
function resize(){[c0,c1,c2,c3].forEach(c=>{c.width=innerWidth;c.height=innerHeight})}
resize();addEventListener('resize',()=>{resize();if(token)initScene()});
const cur=document.getElementById('cur');
document.addEventListener('mousemove',e=>{cur.style.left=(e.clientX-4)+'px';cur.style.top=(e.clientY-4)+'px'});

// ═══ HELPERS ═══
function lerp(a,b,t){return a+(b-a)*t}
function rndEl(arr){return arr[Math.floor(Math.random()*arr.length)]}
function h2r(h){try{const x=parseInt(h.replace('#','').slice(0,6),16);return{r:(x>>16)&255,g:(x>>8)&255,b:x&255}}catch{return{r:6,g:255,b:216}}}
function rgba(h,a=1){const{r,g,b}=h2r(h);return`rgba(${r},${g},${b},${+a.toFixed(3)})`}
const pc=i=>THEME.palette[((i%4)+4)%4];
const delay=ms=>new Promise(r=>setTimeout(r,ms));

// ═══ VARIETY HISTORY (localStorage) ═══
const ALL_SCENES=['WARP_SPEED','LAVA_WORLD','CYBER_GRID','DEEP_SEA','STORM_CHASER','JUNGLE_RAVE','DISCO_DIMENSION','ACID_TRIP','SPACE_STATION','NEON_CATHEDRAL','CLASSIC_ARCADE','ELECTRIC_FOREST','OMNIA_NIGHTCLUB','PIRATE_SHIP','JUNKYARD','SUPERHERO','DAY_OF_DEAD','CHINESE_DRAGON','MOUNT_OLYMPUS','SUPER_MARIO','ATLANTIS','CARNIVAL','EGYPTIAN_TOMB'];
const ALL_CPS=['sun','moon','planet','disco_ball','marshmello_helmet','fireball','black_hole','earth_orbit','vinyl_record','microphone','skull','wormhole','dinosaur_head','chandelier','crystal_ball','robot_head','pixel_character','volcano_peak','neon_cross','lotus','eye','trident','comet','supernova','grim_reaper','angel_wings','alien_head','sugar_skull','zeus_face','dragon_head','roulette_wheel','hourglass','treasure_chest','clock_face','crown','flaming_skull','dna_helix','mandala','tesseract','ankh'];
const NO_REPEAT_WINDOW=15;
function loadJ(k,def){try{return JSON.parse(lg(k)||'null')||def}catch{return def}}
let sceneHist=loadJ('sw_sh',[]),cpHist=loadJ('sw_ch',[]),sceneLastSeen=loadJ('sw_ls',{});
let songCount=parseInt(lg('sw_n')||0),sessionStreak=parseInt(lg('sw_ss')||0);
if(Date.now()-parseInt(lg('sw_st')||0)>3600000){sessionStreak=0;ls('sw_ss','0');} // reset after 1hr gap
// Build shortlist: scenes NOT in last 15, sorted by longest-unseen first
function getSceneShortlist(){
  const recent=new Set(sceneHist.slice(-NO_REPEAT_WINDOW));
  const eligible=ALL_SCENES.filter(s=>!recent.has(s));
  if(eligible.length<4){
    // fallback: least recently used from all scenes
    return ALL_SCENES.slice().sort((a,b)=>(sceneLastSeen[a]||0)-(sceneLastSeen[b]||0)).slice(0,8);
  }
  // Sort by longest unseen first so variety is maximized
  return eligible.sort((a,b)=>(sceneLastSeen[a]||0)-(sceneLastSeen[b]||0));
}
function getForbidCPs(){return cpHist.slice(-15)}
function recordScene(s){
  sceneHist.push(s);if(sceneHist.length>30)sceneHist.shift();
  sceneLastSeen[s]=songCount;
  ls('sw_sh',JSON.stringify(sceneHist));ls('sw_ls',JSON.stringify(sceneLastSeen));
  songCount++;ls('sw_n',songCount);
  sessionStreak++;ls('sw_ss',sessionStreak);ls('sw_st',Date.now());
}
function recordCP(c){if(!c)return;cpHist.push(c);if(cpHist.length>20)cpHist.shift();ls('sw_ch',JSON.stringify(cpHist));}
function enforceScene(s,shortlist){
  // If AI picked something from the shortlist, use it
  if(shortlist.includes(s))return s;
  // Otherwise override with the most overdue eligible scene
  return shortlist[0]||s;
}
function enforceCP(c){if(!c)return null;const f=getForbidCPs();if(!ALL_CPS.includes(c)||f.includes(c)){return rndEl(ALL_CPS.filter(x=>!f.includes(x)))||null;}return c;}

// ═══ STATE ═══
let token=null,lastTid=null,inTrans=false;
let THEME={scene:'WARP_SPEED',label:'',splashDesc:'',palette:['#06ffd8','#8338ec','#ff006e','#ffbe0b'],bgColor:'#000010',centerpiece:null,centerpieceScale:0.5,centerpieceBehavior:'rotate',beatReactions:['shockwave'],sceneSpeed:1,sceneIntensity:0.7,energy:0.5,chaos:0.3};
let aiCache={};
let MS={beatInterval:500,lastBeat:0,duration:180000,analysisStart:0,energy:0.5};
let SM={energy:0.5,beatPulse:0};
let SD={};
let songProg=0,progMult=0.6;
let cpRot=0,cpPh=0,cpOrbit=0;
let beatFX={shockwaveR:0,shockwaveA:0,crackLines:[],invertA:0,slamS:1,speedBoost:0,gravityWave:0};
let beatReactionIdx=0,beatCount=0;
let energyHist=[],surpriseFired=false,surpriseArmed=false,midShifted=false;
let gridGlitch=false;

// ═══ ENERGY SPIKE DETECTION ═══
function pushEnergy(e){energyHist.push(e);if(energyHist.length>60)energyHist.shift();}
function spikeDetected(){
  if(energyHist.length<12)return false;
  const recent=energyHist.slice(-3).reduce((a,b)=>a+b,0)/3;
  const base=energyHist.slice(-15,-5).reduce((a,b)=>a+b,0)/10;
  return recent>base+0.25&&recent>0.62;
}

// ═══ BEAT TRIGGER ═══
function triggerBeat(){
  SM.beatPulse=1;beatCount++;
  const reactions=THEME.beatReactions||['shockwave'];
  const reaction=reactions[beatReactionIdx%reactions.length];
  beatReactionIdx++;
  const intensity=0.5+progMult*0.7;
  switch(reaction){
    case 'speed_burst':beatFX.speedBoost=1.5*intensity;break;
    case 'shockwave':beatFX.shockwaveR=0;beatFX.shockwaveA=0.8*intensity;break;
    case 'color_invert':beatFX.invertA=0.45*intensity;break;
    case 'world_crack':spawnCracks();break;
    case 'bass_slam':beatFX.slamS=1+0.12*intensity;break;
    case 'strobe_cut':beatFX.invertA=THEME.energy>0.6?0.8*intensity:0.3;break;
    case 'creature_surge':if(SD.creatures)SD.creatures.push(mkDeepCreature(W(),H()));break;
    case 'cannon_fire':if(SD.cannonballs)SD.cannonballs.push(mkCannonball());break;
    case 'lightning_strike':if(SD.lightnings!=null)SD.lightnings.push(mkLightning());break;
    case 'gravity_wave':beatFX.gravityWave=1;break;
    case 'petal_burst':if(SD.petals)SD.petals.forEach(p=>{p.vx=(Math.random()-0.5)*5;p.vy=-(Math.random()*4+2);});break;
  }
  // Scene-specific beat actions
  const sc=THEME.scene;
  if(sc==='LAVA_WORLD'&&Math.random()<0.4&&SD.eruptions)SD.eruptions.push(mkEruption());
  if(sc==='STORM_CHASER'&&SD.lightnings!=null)SD.lightnings.push(mkLightning());
  if((sc==='MOUNT_OLYMPUS')&&SD.boltsComing&&Math.random()<0.5)SD.boltsComing.push(mkBolt());
  if(sc==='PIRATE_SHIP'&&SD.cannonballs&&Math.random()<0.3)SD.cannonballs.push(mkCannonball());
  if(sc==='JUNKYARD'&&SD.sparks)for(let i=0;i<8;i++)SD.sparks.push(mkSpark(false));
  if(sc==='CARNIVAL'&&SD.ferrisRot!=null)SD.ferrisRot+=0.15;
  if(sc==='OMNIA_NIGHTCLUB'&&SD.chandelierY!=null)SD.chandelierY=Math.max(H()*0.05,SD.chandelierY-20*(1+progMult));
  // Surprise detection
  pushEnergy(SM.energy);
  if(!surpriseFired&&songProg>0.2){
    surpriseArmed=true;
    if(spikeDetected()){setTimeout(fireSurprise,300);surpriseFired=true;}
  }
  if(!surpriseFired&&songProg>0.85){fireSurprise();surpriseFired=true;}
}
function spawnCracks(){const cx=W()/2,cy=H()/2;beatFX.crackLines=Array.from({length:8},()=>{const a=Math.random()*Math.PI*2,len=Math.random()*Math.max(W(),H())*0.7+100;const segs=[];let x2=cx,y2=cy;for(let i=0;i<6;i++){x2+=Math.cos(a+(Math.random()-0.5)*0.8)*len/6;y2+=Math.sin(a+(Math.random()-0.5)*0.8)*len/6;segs.push({x:x2,y:y2});}return{segs,life:1,ci:Math.floor(Math.random()*4)};});}

// ═══ SURPRISE SYSTEM ═══
function flash(color,ms){const o=document.getElementById('surpriseOverlay');o.style.background=color;o.style.transition='opacity 0.08s';o.style.opacity='1';setTimeout(()=>{o.style.transition=`opacity ${ms}ms ease`;o.style.opacity='0';},100);}
function fireSurprise(){
  // Rare mid-song world shift
  if(!midShifted&&Math.random()<0.18&&songProg>0.3&&songProg<0.75){
    midShifted=true;
    const f=getForbidScenes(),pool=ALL_SCENES.filter(s=>s!==THEME.scene&&!f.includes(s));
    const newScene=rndEl(pool);
    const savedScene=THEME.scene;
    setTimeout(()=>{THEME.scene=newScene;initScene();setTimeout(()=>{THEME.scene=savedScene;initScene();},9000);},400);
    return;
  }
  const sc=THEME.scene;
  if(sc==='WARP_SPEED'){beatFX.speedBoost=4;setTimeout(()=>beatFX.speedBoost=0,1500);}
  else if(sc==='LAVA_WORLD'){for(let i=0;i<8;i++)SD.eruptions&&SD.eruptions.push(mkEruption());flash(rgba(pc(0),0.7),2000);}
  else if(sc==='DEEP_SEA'){
    // Massive creature fills the screen + bioluminescent explosion
    if(SD.creatures)SD.creatures.push({...mkDeepCreature(W(),H()),sz:Math.min(W(),H())*0.7,vx:2.5,y:H()*0.4});
    if(SD.plankton)SD.plankton.forEach(p=>{p.vy*=6;});
    flash(rgba(pc(0),0.5),2500);
    // Tentacles everywhere
    setTimeout(()=>{if(SD.creatures)for(let i=0;i<3;i++)SD.creatures.push({...mkDeepCreature(W(),H()),sz:Math.min(W(),H())*0.35,vx:1.5+i*0.5});},400);
  }
  else if(sc==='CYBER_GRID'){
    // Full matrix meltdown — buildings collapse, glitch overload, data cascade
    gridGlitch=true;
    if(SD.dataStreams)SD.dataStreams.forEach(ds=>ds.speed*=6);
    if(SD.buildings)SD.buildings.forEach(b=>{b.h*=1.5;b.ci=(b.ci+1)%4;});
    beatFX.invertA=0.6;
    setTimeout(()=>{gridGlitch=false;if(SD.dataStreams)SD.dataStreams.forEach(ds=>ds.speed/=6);if(SD.buildings)SD.buildings.forEach(b=>b.h/=1.5);},3000);
    flash(rgba(pc(0),0.8),200);setTimeout(()=>flash(rgba(pc(1),0.8),200),300);
  }
  else if(sc==='STORM_CHASER'){for(let i=0;i<8;i++)SD.lightnings&&SD.lightnings.push(mkLightning());flash('rgba(255,255,255,0.9)',200);}
  else if(sc==='JUNGLE_RAVE'){
    // Stampede — screen fills with creatures + plants glow blinding
    if(SD.creatures)for(let i=0;i<5;i++)SD.creatures.push({...mkJungleCreature(W(),H()),sz:220+i*30,vx:-(1.5+i*0.5),y:H()*(0.3+i*0.1)});
    if(SD.plants)SD.plants.forEach(p=>{p.glowMult=5;});
    if(SD.spores)SD.spores.forEach(sp=>{sp.vy*=8;});
    flash(rgba(pc(2),0.6),1500);
  }
  else if(sc==='DISCO_DIMENSION'){if(SD.chandeliers)SD.chandeliers.forEach(c=>c.drop=true);flash(rgba(pc(1),0.5),600);}
  else if(sc==='ACID_TRIP'){beatFX.invertA=0.85;setTimeout(()=>beatFX.invertA=0,2000);}
  else if(sc==='SPACE_STATION'){
    // Hull breach — red alert, debris flies everywhere, viewport cracks
    SD.hullBreachActive=true;
    if(SD.debris)for(let i=0;i<8;i++)SD.debris.push({...mkDebris(),vx:(Math.random()-0.5)*12,vy:(Math.random()-0.5)*12});
    flash('rgba(255,0,0,0.5)',300);setTimeout(()=>flash('rgba(255,0,0,0.4)',300),400);setTimeout(()=>flash('rgba(255,50,0,0.3)',500),900);
    beatFX.speedBoost=2.5;
    // Red alert flicker
    for(let i=0;i<6;i++)setTimeout(()=>{document.getElementById('surpriseOverlay').style.background='rgba(200,0,0,0.12)';document.getElementById('surpriseOverlay').style.opacity='1';setTimeout(()=>document.getElementById('surpriseOverlay').style.opacity='0',80);},i*180);
    setTimeout(()=>SD.hullBreachActive=false,5000);
  }
  else if(sc==='NEON_CATHEDRAL'){
    // All rays converge to center — blinding convergence + stained glass shatter
    beatFX.invertA=0.7;
    if(SD.rays)SD.rays.forEach(lr=>{lr.x=W()/2+(lr.x-W()/2)*0.1;});
    flash(rgba(pc(0),0.9),150);setTimeout(()=>flash('rgba(255,255,255,0.95)',100),200);setTimeout(()=>flash(rgba(pc(1),0.7),400),400);
    if(SD.motes)SD.motes.forEach(p=>{p.vy*=8;p.vx=(Math.random()-0.5)*5;});
    setTimeout(()=>{if(SD.rays)SD.rays.forEach((lr,i)=>lr.x=lr.x*(0.1+Math.random()*0.9)+W()*0.05*(i%4));},2000);
  }
  else if(sc==='CLASSIC_ARCADE'){showGameOver();}
  else if(sc==='ELECTRIC_FOREST'){if(SD.trees)SD.trees.forEach(t=>t.glowMult=3);}
  else if(sc==='OMNIA_NIGHTCLUB'){if(SD.chandelierY!=null){const orig=SD.chandelierY;SD.chandelierY=H()*0.5;flash(rgba(pc(0),0.5),300);setTimeout(()=>SD.chandelierY=orig,3000);}}
  else if(sc==='PIRATE_SHIP'){for(let i=0;i<8;i++)setTimeout(()=>SD.cannonballs&&SD.cannonballs.push(mkCannonball()),i*150);flash('rgba(255,150,0,0.5)',400);}
  else if(sc==='JUNKYARD'){
    // Wrecking ball goes berserk + explosion of sparks + all arms swing
    beatFX.gravityWave=2;beatFX.speedBoost=1.5;
    for(let i=0;i<60;i++)SD.sparks&&SD.sparks.push(mkSpark(false));
    if(SD.arms)SD.arms.forEach(arm=>{arm.targetAngle=-Math.PI*(0.1+Math.random()*0.8);arm.speed*=4;setTimeout(()=>arm.speed/=4,2000);});
    flash(rgba(pc(1),0.7),150);setTimeout(()=>flash(rgba(pc(0),0.5),200),200);
    for(let i=0;i<5;i++)setTimeout(()=>{for(let j=0;j<15;j++)SD.sparks&&SD.sparks.push(mkSpark(false));},i*300);
  }
  else if(sc==='SUPERHERO'){doComicBurst();}
  else if(sc==='DAY_OF_DEAD'){if(SD.skulls)SD.skulls.forEach(s=>{s.sz*=1.8;});flash(rgba(pc(0),0.4),600);}
  else if(sc==='CHINESE_DRAGON'){if(SD.dragonEmerge!=null)SD.dragonEmerge=1;flash(rgba(pc(0),0.6),500);}
  else if(sc==='MOUNT_OLYMPUS'){for(let i=0;i<12;i++)SD.boltsComing&&SD.boltsComing.push(mkBolt());flash('rgba(255,255,100,0.8)',300);if(SD.zeusFace)SD.zeusFace.alpha=1;}
  else if(sc==='SUPER_MARIO'){flash(rgba(pc(0),0.6),200);}
  else if(sc==='ATLANTIS'){flash(rgba(pc(2),0.6),800);beatFX.gravityWave=1.5;}
  else if(sc==='CARNIVAL'){for(let i=0;i<5;i++)setTimeout(()=>{beatFX.shockwaveR=0;beatFX.shockwaveA=1;},i*280);}
  else if(sc==='EGYPTIAN_TOMB'){if(SD.traps)for(let i=0;i<4;i++)SD.traps.push({x:Math.random()*W(),y:0,vy:Math.random()*8+4,life:1,ci:Math.floor(Math.random()*4)});flash(rgba(pc(1),0.5),400);}
  else{flash(rgba(pc(0),0.7),600);}
}
function showGameOver(){const g=document.getElementById('gameOverScreen');g.style.display='flex';setTimeout(()=>g.style.display='none',2500);}
function doComicBurst(){const panel=document.getElementById('comicPanel');panel.style.display='block';const words=['POW!','ZAP!','BOOM!','WHAM!','KA-BAM!'];const cols=['#ff0','#f0f','#0ff','#f60'];panel.innerHTML='';for(let i=0;i<3;i++){const d=document.createElement('div');d.style.cssText=`position:absolute;font-size:${Math.random()*5+4}rem;color:${cols[i%4]};text-shadow:3px 3px 0 #000;left:${Math.random()*70+5}%;top:${Math.random()*70+5}%;transform:rotate(${(Math.random()-0.5)*30}deg)`;d.textContent=words[Math.floor(Math.random()*words.length)];panel.appendChild(d);}setTimeout(()=>panel.style.display='none',2200);}


// ═══ PARTICLE FACTORIES ═══
function mkEmber(init){return{x:Math.random()*W(),y:init?Math.random()*H():H()+10,vx:(Math.random()-0.5)*2,vy:-(Math.random()*3+1),r:Math.random()*4+1,life:Math.random()*0.6+0.4,ci:Math.floor(Math.random()*2)}}
function mkEruption(){return{x:Math.random()*W(),particles:Array.from({length:35},()=>({vx:(Math.random()-0.5)*10,vy:-(Math.random()*14+6),life:1,ci:Math.floor(Math.random()*2)})),life:1}}
function mkDeepCreature(w,h){return{x:-200,y:Math.random()*(h||H())*0.8+((h||H())*0.05),vx:Math.random()*0.8+0.2,sz:Math.random()*180+60,type:Math.floor(Math.random()*4),ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2,tentacles:Array.from({length:8},()=>({ph:Math.random()*Math.PI*2,len:Math.random()*0.8+0.4}))}}
function mkJungleCreature(w,h){return{x:(w||W())+100,y:((h||H())*0.3)+Math.random()*(h||H())*0.4,vx:-(Math.random()*1+0.3),sz:Math.random()*120+60,type:Math.floor(Math.random()*3),ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}}
function mkSpark(init){return{x:Math.random()*W(),y:init?Math.random()*H():(H()*0.4+Math.random()*H()*0.3),vx:(Math.random()-0.5)*6,vy:-(Math.random()*8+2),life:Math.random()*0.6+0.2,ci:Math.floor(Math.random()*2)}}
function mkCannonball(){return{x:W()*0.15+Math.random()*W()*0.1,y:H()*0.55,vx:Math.random()*8+4,vy:-(Math.random()*4+2),r:8,life:1}}
function mkLightning(){const w=W(),h=H();let x2=Math.random()*w,y2=0;const segs=[];while(y2<h){const dy=Math.random()*50+20,dx=(Math.random()-0.5)*80;segs.push({x1:x2,y1:y2,x2:x2+dx,y2:y2+dy});x2+=dx;y2+=dy;}return{segs,life:1,ci:Math.floor(Math.random()*4)}}
function mkBolt(){const w=W(),h=H(),cx=w/2+(Math.random()-0.5)*w*0.4;return{x:cx,y:-50,vx:(Math.random()-0.5)*3,vy:Math.random()*8+5,size:Math.random()*30+15,ci:Math.floor(Math.random()*4),life:1}}
function mkDebris(){const a=Math.random()*Math.PI*2,spd=Math.random()*5+2;return{x:Math.random()*W(),y:Math.random()*H(),vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.2,sz:Math.random()*30+5,ci:Math.floor(Math.random()*4),type:Math.floor(Math.random()*3)}}

// ═══ SCENE INIT ═══
function initScene(){
  SD={};
  const w=W(),h=H(),sc=THEME.scene;
  if(sc==='WARP_SPEED'||sc==='SPACE_STATION')SD.stars=Array.from({length:500},()=>({x:(Math.random()-0.5)*2,y:(Math.random()-0.5)*2,z:Math.random(),ci:Math.floor(Math.random()*4),trail:[]}));
  if(sc==='LAVA_WORLD'){SD.embers=Array.from({length:200},()=>mkEmber(true));SD.eruptions=[];}
  if(sc==='CYBER_GRID'){SD.gridZ=0;SD.buildings=Array.from({length:30},(_,i)=>({x:(i%6-2.5)*w*0.18,h:Math.random()*h*0.6+h*0.15,w:Math.random()*80+30,z:i/30,ci:i%4}));SD.dataStreams=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,speed:Math.random()*4+2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='DEEP_SEA'){SD.creatures=Array.from({length:5},()=>mkDeepCreature(w,h));SD.plankton=Array.from({length:150},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*3+0.5,vy:-(Math.random()*0.4+0.1),vx:(Math.random()-0.5)*0.3,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}));}
  if(sc==='STORM_CHASER'){SD.debris=Array.from({length:80},()=>mkDebris());SD.lightnings=[];SD.ltTimer=0;SD.tornadoA=0;}
  if(sc==='JUNGLE_RAVE'){SD.plants=Array.from({length:25},(_,i)=>({x:w*(i/24),sz:Math.random()*150+60,ph:Math.random()*Math.PI*2,ci:i%4,type:i%3,glowMult:1}));SD.creatures=Array.from({length:3},()=>mkJungleCreature(w,h));SD.spores=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.8,vy:-(Math.random()*0.5+0.1),r:Math.random()*4+1,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='DISCO_DIMENSION'){SD.tileZ=0;SD.chandeliers=Array.from({length:3},(_,i)=>({x:w*(0.2+i*0.3),y:h*0.05,rot:Math.random()*Math.PI*2,rotS:0.006+Math.random()*0.01,size:Math.random()*80+60,drop:false}));SD.beams=Array.from({length:20},()=>({x:Math.random()*w,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));}
  if(sc==='ACID_TRIP'){SD.fracPh=0;SD.colorCyc=0;SD.warpGrid=[];for(let gx=0;gx<=20;gx++)for(let gy=0;gy<=14;gy++)SD.warpGrid.push({gx,gy,ph:Math.random()*Math.PI*2});}
  if(sc==='SPACE_STATION'){SD.debris=Array.from({length:12},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.3,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.01,sz:Math.random()*40+10,ci:Math.floor(Math.random()*4)}));}
  if(sc==='NEON_CATHEDRAL'){SD.arches=Array.from({length:6},(_,i)=>({depth:i/5,width:1-i*0.12,ci:i%4}));SD.rays=Array.from({length:12},()=>({x:Math.random()*w,width:Math.random()*60+20,alpha:Math.random()*0.3+0.05,ph:Math.random()*Math.PI*2}));SD.motes=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,vy:-(Math.random()*0.8+0.2),r:Math.random()*2+0.5,ci:Math.floor(Math.random()*4),ph:Math.random()*Math.PI*2}));}
  if(sc==='CLASSIC_ARCADE'){SD.pixels=Array.from({length:200},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*2,vy:(Math.random()-0.5)*2,size:Math.floor(Math.random()*3+1)*8,ci:Math.floor(Math.random()*4),type:Math.floor(Math.random()*4)}));SD.scanLine=0;SD.mazeLines=Array.from({length:20},()=>{const mx=Math.random()*w,my=Math.random()*h;return{x1:mx,y1:my,x2:mx+(Math.random()-0.5)*200,y2:my+(Math.random()-0.5)*200,ci:Math.floor(Math.random()*4)};});}
  if(sc==='ELECTRIC_FOREST'){SD.trees=Array.from({length:20},(_,i)=>({x:w*(i/19),sz:Math.random()*120+60,ph:Math.random()*Math.PI*2,ci:i%4,glowMult:1}));SD.fairies=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.2,vy:(Math.random()-0.5)*0.8,r:Math.random()*4+2,ph:Math.random()*Math.PI*2,ci:Math.floor(Math.random()*4)}));SD.mushrooms=Array.from({length:12},(_,i)=>({x:w*(i/11),sz:Math.random()*60+30,ci:i%4,ph:Math.random()*Math.PI*2}));}
  if(sc==='OMNIA_NIGHTCLUB'){SD.crowdPeople=Array.from({length:60},()=>({x:Math.random()*w,y:h*0.55+Math.random()*h*0.35,ph:Math.random()*Math.PI*2,sz:Math.random()*25+15,ci:Math.floor(Math.random()*4)}));SD.chandelierY=h*0.05;SD.chandelierRot=0;SD.beams=Array.from({length:24},(_,i)=>({angle:i/24*Math.PI*2,ci:i%4,ph:Math.random()*Math.PI*2,len:Math.random()*h*0.5+h*0.3}));}
  if(sc==='PIRATE_SHIP'){SD.waves=Array.from({length:5},(_,i)=>({ph:Math.random()*Math.PI*2,speed:0.002+i*0.001,amp:30+i*15}));SD.cannonballs=[];SD.stars=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h*0.45,br:Math.random()}));SD.seagulls=Array.from({length:6},()=>({x:Math.random()*w,y:Math.random()*h*0.3,vx:Math.random()*1.5+0.5,ph:0}));}
  if(sc==='JUNKYARD'){SD.sparks=Array.from({length:60},()=>mkSpark(true));SD.arms=Array.from({length:4},(_,i)=>({x:w*(0.15+i*0.23),baseY:h*0.6,angle:-Math.PI*0.6,targetAngle:-Math.PI*0.4,speed:0.02+i*0.005,sz:Math.random()*80+60,ci:i%4}));SD.carStacks=Array.from({length:8},(_,i)=>({x:i/7,cars:Math.floor(Math.random()*3+2),ci:i%4}));}
  if(sc==='SUPERHERO'){SD.cityBuildings=Array.from({length:20},(_,i)=>({x:i*w/19,h:Math.random()*h*0.55+h*0.1,w:Math.random()*60+25,ci:i%4,windows:[]}));SD.cityBuildings.forEach(b=>{for(let wy=5;wy<b.h;wy+=18)for(let wx=4;wx<b.w-4;wx+=14)if(Math.random()<0.6)b.windows.push({x:wx,y:wy,on:Math.random()<0.8});});SD.spotlightA=0;}
  if(sc==='DAY_OF_DEAD'){SD.petals=Array.from({length:120},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.5,vy:Math.random()*1.5+0.3,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.05,sz:Math.random()*10+4,ci:Math.floor(Math.random()*4)}));SD.candles=Array.from({length:12},(_,i)=>({x:w*(i/11),flicker:Math.random()*Math.PI*2,sz:Math.random()*15+10}));SD.skulls=Array.from({length:6},(_,i)=>({x:w*(0.1+i*0.16),y:h*0.4+Math.random()*h*0.2,ph:Math.random()*Math.PI*2,sz:Math.random()*40+25,ci:i%4}));}
  if(sc==='CHINESE_DRAGON'){SD.dragonEmerge=0;SD.fog=Array.from({length:8},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*150+80,ph:Math.random()*Math.PI*2,speed:0.001+Math.random()*0.002}));}
  if(sc==='MOUNT_OLYMPUS'){SD.lightnings=[];SD.ltTimer=0;SD.clouds=Array.from({length:8},()=>({x:Math.random()*w,y:Math.random()*h*0.6,r:Math.random()*120+60,vx:(Math.random()-0.5)*0.3,ci:Math.floor(Math.random()*2)}));SD.boltsComing=[];SD.zeusFace={alpha:0,scale:0.3};}
  if(sc==='SUPER_MARIO'){SD.platforms=Array.from({length:12},(_,i)=>({x:i*w/11,y:h*0.4+Math.sin(i)*h*0.2,w:Math.random()*120+60}));SD.coins=Array.from({length:20},()=>({x:Math.random()*w,y:Math.random()*h*0.7,ph:0}));SD.goombas=Array.from({length:5},()=>({x:Math.random()*w,y:h*0.75,vx:(Math.random()-0.5)*2}));SD.scrollX=0;SD.pipes=Array.from({length:4},(_,i)=>({x:w*(0.15+i*0.23),h:Math.random()*h*0.25+h*0.1}));}
  if(sc==='ATLANTIS'){SD.fish=Array.from({length:30},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*1.5,vy:(Math.random()-0.5)*0.5,sz:Math.random()*20+8,ci:Math.floor(Math.random()*4)}));SD.bubbles=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*8+2,vy:-(Math.random()*0.8+0.2),ph:Math.random()*Math.PI*2}));SD.ruins=Array.from({length:10},(_,i)=>({x:i/9,h:Math.random()*h*0.4+h*0.1,w:Math.random()*80+30,ci:i%4}));SD.lightShafts=Array.from({length:6},(_,i)=>({x:w*(0.05+i*0.18),ph:Math.random()*Math.PI*2}));}
  if(sc==='CARNIVAL'){SD.ferrisSegs=Array.from({length:12},(_,i)=>({angle:i/12*Math.PI*2,ci:i%4}));SD.ferrisRot=0;SD.confetti=Array.from({length:150},()=>({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*2,vy:Math.random()*2+0.5,rot:Math.random()*Math.PI*2,rotS:(Math.random()-0.5)*0.1,sz:Math.random()*8+3,ci:Math.floor(Math.random()*4)}));SD.tentLights=Array.from({length:16},(_,i)=>({angle:i/16*Math.PI*2,ph:Math.random()*Math.PI*2,ci:i%4}));}
  if(sc==='EGYPTIAN_TOMB'){SD.hieroglyphs=Array.from({length:40},()=>({x:Math.random()*w,y:Math.random()*h,char:Math.floor(Math.random()*12),ci:Math.floor(Math.random()*4),alpha:Math.random()*0.5+0.2}));SD.torches=Array.from({length:6},(_,i)=>({x:(i/5)*0.9+0.05,ph:Math.random()*Math.PI*2}));SD.tunnelZ=0;SD.traps=[];}
  beatFX={shockwaveR:0,shockwaveA:0,crackLines:[],invertA:0,slamS:1,speedBoost:0,gravityWave:0};
  energyHist=[];surpriseFired=false;surpriseArmed=false;midShifted=false;beatReactionIdx=0;beatCount=0;cpRot=0;cpPh=0;cpOrbit=0;cpBounceX=0;cpBounceY=0;cpBounceVX=0.7+(Math.random()-0.5)*0.4;cpBounceVY=0.5+(Math.random()-0.5)*0.3;cpDriftX=0;cpDriftY=0;
}

// ═══ SCENE RENDERERS ═══
function drawWarpSpeed(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(!SD.stars)return;
  const spd=THEME.sceneSpeed*(0.6+progMult*0.5)*(1+SM.energy)*(1+beatFX.speedBoost*1.5);
  for(const s of SD.stars){
    s.z-=0.0018*spd;if(s.z<0.01){s.z=1;s.x=(Math.random()-0.5)*2;s.y=(Math.random()-0.5)*2;s.trail=[];}
    const px=cx+(s.x/s.z)*cx,py=cy+(s.y/s.z)*cy;
    if(px<-30||px>w+30||py<-30||py>h+30)continue;
    const sz=(1-s.z)*6+0.3;
    if(s.trail.length>1){x0.beginPath();x0.moveTo(s.trail[0].x,s.trail[0].y);for(let i=1;i<s.trail.length;i++)x0.lineTo(s.trail[i].x,s.trail[i].y);x0.lineTo(px,py);x0.strokeStyle=rgba(pc(s.ci),(1-s.z)*0.6);x0.lineWidth=sz*0.5;x0.stroke();}
    s.trail.push({x:px,y:py});if(s.trail.length>8)s.trail.shift();
    x0.beginPath();x0.arc(px,py,sz,0,Math.PI*2);x0.fillStyle=rgba(pc(s.ci),(1-s.z)*0.95);x0.shadowBlur=sz*3;x0.shadowColor=pc(s.ci);x0.fill();x0.shadowBlur=0;
  }
  // Centerpiece as the massive object you're hurtling TOWARD — grows from tiny dot to filling screen
  if(THEME.centerpiece){
    const approach=0.05+songProg*0.5+SM.beatPulse*0.08; // grows over song
    const targetSz=Math.min(w,h)*approach;
    x1.clearRect(0,0,w,h);
    x1.save();x1.translate(cx,cy);x1.rotate(cpRot*0.3);
    x1.globalAlpha=Math.min(1,approach*1.5);
    // Draw scaled version of centerpiece inline
    const s2=targetSz*0.5;
    const og=x1.createRadialGradient(0,0,0,0,0,s2*1.8);og.addColorStop(0,rgba(pc(0),0.15*(1+SM.beatPulse)));og.addColorStop(1,'transparent');x1.fillStyle=og;x1.beginPath();x1.arc(0,0,s2*1.8,0,Math.PI*2);x1.fill();
    x1.shadowBlur=s2*0.5;x1.shadowColor=pc(0);
    const pg=x1.createRadialGradient(-s2*0.3,-s2*0.3,0,0,0,s2);pg.addColorStop(0,rgba(pc(2),1));pg.addColorStop(0.6,rgba(pc(0),0.8));pg.addColorStop(1,rgba(pc(1),0.3));x1.fillStyle=pg;x1.beginPath();x1.arc(0,0,s2,0,Math.PI*2);x1.fill();x1.shadowBlur=0;
    x1.restore();
    cpRot+=0.008;
  }
}
function drawLavaWorld(t){
  const w=W(),h=H();
  const sky=x0.createLinearGradient(0,0,0,h);sky.addColorStop(0,THEME.bgColor);sky.addColorStop(0.3,rgba(pc(1),0.4*(0.5+progMult*0.6)));sky.addColorStop(1,'rgba(0,0,0,0)');x0.fillStyle=sky;x0.fillRect(0,0,w,h);
  for(let lv=0;lv<4;lv++){x0.beginPath();for(let px=0;px<=w;px+=4){const py=h*(0.58+lv*0.08)+Math.sin(px*0.01+t*0.002+lv)*25+Math.sin(px*0.03+t*0.003)*12;px===0?x0.moveTo(px,py):x0.lineTo(px,py);}x0.lineTo(w,h);x0.lineTo(0,h);x0.closePath();const lg=x0.createLinearGradient(0,h*0.58,0,h);const c0h=h2r(pc(0)),c1h=h2r(pc(1));lg.addColorStop(0,`rgba(${c0h.r},${c0h.g},${c0h.b},${0.7*(1+SM.beatPulse*0.2)})`);lg.addColorStop(0.5,`rgba(${c1h.r},${c1h.g},${c1h.b},0.7)`);lg.addColorStop(1,'rgba(255,40,0,0.85)');x0.fillStyle=lg;x0.fill();}
  if(SD.embers)for(let i=SD.embers.length-1;i>=0;i--){const e=SD.embers[i];e.x+=e.vx;e.y+=e.vy*(1+SM.energy*0.5);e.life-=0.004;if(e.life<=0||e.y<-20){SD.embers[i]=mkEmber(false);continue;}x0.beginPath();x0.arc(e.x,e.y,e.r*e.life,0,Math.PI*2);x0.fillStyle=rgba(pc(e.ci),e.life*0.9);x0.shadowBlur=8;x0.shadowColor=pc(e.ci);x0.fill();x0.shadowBlur=0;}
  if(SD.eruptions)for(let i=SD.eruptions.length-1;i>=0;i--){const er=SD.eruptions[i];er.life-=0.02;for(const p of er.particles){p.vx*=0.97;p.vy+=0.35;p.life-=0.02;if(p.life>0){x0.beginPath();x0.arc(er.x+p.vx*(1-p.life)*25,er.y-p.vy*(1-p.life)*25,p.life*6,0,Math.PI*2);x0.fillStyle=rgba(pc(p.ci),p.life*0.9);x0.shadowBlur=10;x0.shadowColor=pc(p.ci);x0.fill();x0.shadowBlur=0;}}if(er.life<=0)SD.eruptions.splice(i,1);}
  x0.fillStyle='rgba(0,0,0,0.75)';x0.beginPath();x0.moveTo(0,h);x0.lineTo(w*0.3,h*0.38);x0.lineTo(w*0.35,h*0.35);x0.lineTo(w*0.4,h*0.38);x0.lineTo(w,h);x0.closePath();x0.fill();
  const gg=x0.createRadialGradient(w*0.35,h*0.35,0,w*0.35,h*0.35,w*0.1);gg.addColorStop(0,rgba(pc(0),0.9*(1+SM.beatPulse*0.4)));gg.addColorStop(1,'transparent');x0.fillStyle=gg;x0.fillRect(0,0,w,h);
}
function drawCyberGrid(t){
  const w=W(),h=H(),vpy=h*0.45,vpx=w/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Grid corruption grows over song
  const corruption=songProg*0.4;
  if(gridGlitch||corruption>0.15){
    const glitchAmt=gridGlitch?0.3:corruption*0.15;
    x0.fillStyle=rgba(pc(0),glitchAmt);
    for(let i=0;i<(gridGlitch?12:3);i++)x0.fillRect(0,Math.random()*h,w,Math.random()*(gridGlitch?40:8)+2);
    if(gridGlitch)for(let i=0;i<5;i++){x0.fillStyle=rgba(pc(i%4),0.1);x0.fillRect(Math.random()*w,0,Math.random()*80+10,h);}
  }
  SD.gridZ=(SD.gridZ||0)+THEME.sceneSpeed*(1+beatFX.speedBoost)*0.012*(1+SM.energy*0.5)*progMult;
  const GRID=12,COLS=24;
  for(let row=0;row<GRID;row++){const z=((row/GRID+SD.gridZ)%1),py=lerp(vpy,h,z),px1=lerp(vpx,0,z),px2=lerp(vpx,w,z),alpha=(0.05+z*0.5)*THEME.sceneIntensity*(1+SM.beatPulse*0.3);
    // Grid color shifts as song progresses
    const ci=Math.floor(row/3+corruption*8)%4;
    x0.strokeStyle=rgba(pc(ci),alpha);x0.lineWidth=1+z*2;x0.shadowBlur=z>0.7?10+corruption*20:0;x0.shadowColor=pc(ci);x0.beginPath();x0.moveTo(px1,py);x0.lineTo(px2,py);x0.stroke();}
  x0.shadowBlur=0;
  for(let col=0;col<=COLS;col++){const nx=(col/COLS-0.5)*2;x0.beginPath();x0.moveTo(vpx+nx*vpx*0.01,vpy);x0.lineTo(vpx+nx*w*0.5,h);x0.strokeStyle=rgba(pc(1),(Math.abs(nx)<0.2?0.4:0.15)*THEME.sceneIntensity);x0.lineWidth=1;x0.stroke();}
  if(SD.buildings)for(const b of SD.buildings){const depth=((b.z+SD.gridZ*0.5)%1),scale=0.1+depth*0.9;const bx=vpx+b.x*(1-depth)*w*0.4,by=vpy+(h-vpy)*depth,bw=b.w*scale,bh=b.h*scale;x0.fillStyle=rgba(pc(b.ci),0.08+depth*0.12+corruption*0.1);x0.fillRect(bx-bw/2,by-bh,bw,bh);x0.strokeStyle=rgba(pc(b.ci),0.4*depth);x0.lineWidth=1;x0.shadowBlur=8*depth+corruption*15;x0.shadowColor=pc(b.ci);x0.strokeRect(bx-bw/2,by-bh,bw,2);x0.shadowBlur=0;}
  if(SD.dataStreams)for(const ds of SD.dataStreams){ds.y=(ds.y+ds.speed*(1+SM.energy*0.5+corruption*0.5))%h;x0.fillStyle=rgba(pc(ds.ci),0.5+corruption*0.3);x0.font='12px Share Tech Mono';x0.fillText(String.fromCharCode(0x30A0+Math.floor(Math.random()*96)),ds.x,ds.y);}
  // Centerpiece as watermark/texture on the grid floor
  if(THEME.centerpiece){
    x1.clearRect(0,0,w,h);x1.save();
    x1.translate(vpx,h*0.95);x1.rotate(SD.gridZ*0.5);
    x1.globalAlpha=(0.04+SM.beatPulse*0.06)*(1+corruption);
    x1.shadowBlur=20*(1+corruption*2);x1.shadowColor=pc(0);
    const gs=Math.min(w,h)*0.15*(1+SM.beatPulse*0.2);
    const gg=x1.createRadialGradient(0,0,0,0,0,gs);gg.addColorStop(0,rgba(pc(0),1));gg.addColorStop(1,'transparent');x1.fillStyle=gg;x1.beginPath();x1.arc(0,0,gs,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();
    cpRot+=0.005;
  }
}
function drawDeepSea(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Depth glow evolves over song — gets brighter/more bioluminescent
  const depthGlow=0.3+songProg*0.7;
  for(let i=0;i<3;i++){const gx=w*(0.2+i*0.3)+Math.sin(t*0.0003+i)*w*0.1,gy=h*(0.3+i*0.2)+Math.cos(t*0.0002+i)*h*0.08;const gr=x0.createRadialGradient(gx,gy,0,gx,gy,w*0.25);const gc=h2r(pc(i%4));gr.addColorStop(0,`rgba(${gc.r},${gc.g},${gc.b},${0.06*THEME.sceneIntensity*(1+SM.beatPulse*0.2)*depthGlow})`);gr.addColorStop(1,'transparent');x0.fillStyle=gr;x0.fillRect(0,0,w,h);}
  // Light shafts from above grow as song progresses
  if(songProg>0.2){for(let ls=0;ls<4;ls++){const lx=w*(0.1+ls*0.25)+Math.sin(t*0.0002+ls)*30;x0.save();x0.globalAlpha=(songProg-0.2)*0.06*(1+SM.beatPulse*0.3);const lg=x0.createLinearGradient(lx,0,lx+40,h*0.6);const lc=h2r(pc(ls%4));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;x0.beginPath();x0.moveTo(lx,0);x0.lineTo(lx+80,0);x0.lineTo(lx+160,h*0.6);x0.lineTo(lx-80,h*0.6);x0.closePath();x0.fill();x0.restore();}}
  if(SD.plankton)for(const p of SD.plankton){p.x+=p.vx;p.y+=p.vy;p.ph+=0.04;if(p.y<-5){p.y=h+5;p.x=Math.random()*w;}const br=Math.sin(p.ph)*0.4+0.6;x0.beginPath();x0.arc(p.x,p.y,p.r*(0.7+br*0.3),0,Math.PI*2);x0.fillStyle=rgba(pc(p.ci),br*0.7*depthGlow);x0.shadowBlur=8*depthGlow;x0.shadowColor=pc(p.ci);x0.fill();x0.shadowBlur=0;}
  if(SD.creatures)for(let i=SD.creatures.length-1;i>=0;i--){const cr=SD.creatures[i];cr.x+=cr.vx*(1+SM.energy*0.3);cr.ph+=0.02;if(cr.x>w+cr.sz*2){SD.creatures[i]=mkDeepCreature(w,h);continue;}x0.save();x0.translate(cr.x,cr.y+Math.sin(cr.ph)*15);const scale=Math.max(0.1,cr.x/w);x0.scale(scale,scale);x0.shadowBlur=30*scale*depthGlow;x0.shadowColor=pc(cr.ci);const alpha=Math.min(1,cr.x/(w*0.3))*THEME.sceneIntensity;x0.strokeStyle=rgba(pc(cr.ci),alpha*0.8);x0.lineWidth=2;x0.beginPath();x0.ellipse(0,0,cr.sz*0.7,cr.sz*0.5*(0.8+Math.sin(cr.ph)*0.2),0,Math.PI,0);x0.stroke();if(cr.tentacles)for(const ten of cr.tentacles){ten.ph+=0.03;x0.beginPath();x0.moveTo(Math.cos(ten.ph)*cr.sz*0.5,0);x0.bezierCurveTo(Math.cos(ten.ph)*cr.sz*0.5+Math.sin(cr.ph+ten.ph)*20,cr.sz,Math.cos(ten.ph)*cr.sz*0.5,cr.sz*1.5*ten.len,Math.cos(ten.ph)*cr.sz*0.5+Math.sin(cr.ph)*10,cr.sz*2*ten.len);x0.strokeStyle=rgba(pc(cr.ci),alpha*0.4);x0.lineWidth=1.5;x0.stroke();}x0.shadowBlur=0;x0.restore();}
  // Centerpiece as the giant creature silhouette emerging from deep
  if(THEME.centerpiece){
    const emerge=0.1+songProg*0.6;
    const creatureSz=Math.min(w,h)*(0.3+emerge*0.4);
    x1.clearRect(0,0,w,h);x1.save();
    x1.translate(w*0.5,h*(0.3+Math.sin(t*0.0004)*0.05));
    x1.shadowBlur=creatureSz*0.4*depthGlow;x1.shadowColor=pc(0);
    x1.globalAlpha=emerge*0.7;
    // Looming silhouette shape
    x1.fillStyle=rgba(pc(0),0.5);x1.beginPath();x1.ellipse(0,0,creatureSz*0.9,creatureSz*0.55,0,0,Math.PI*2);x1.fill();
    // Eyes glow
    x1.shadowBlur=30;x1.shadowColor=pc(1);x1.fillStyle=rgba(pc(1),0.95);
    for(const[ex,ey]of[[-creatureSz*0.28,-creatureSz*0.08],[creatureSz*0.28,-creatureSz*0.08]]){x1.beginPath();x1.arc(ex,ey,creatureSz*0.07*(1+SM.beatPulse*0.5),0,Math.PI*2);x1.fill();}
    // Tentacles
    x1.strokeStyle=rgba(pc(0),0.4*emerge);x1.lineWidth=creatureSz*0.06;
    for(let ten=0;ten<8;ten++){const ta=ten/8*Math.PI+Math.PI+Math.sin(t*0.001+ten)*0.3;x1.beginPath();x1.moveTo(Math.cos(ta)*creatureSz*0.7,Math.sin(ta)*creatureSz*0.4);x1.bezierCurveTo(Math.cos(ta)*creatureSz*1.2,Math.sin(ta)*creatureSz*0.8+50,Math.cos(ta)*creatureSz*1.1,Math.sin(ta)*creatureSz*1.4,Math.cos(ta+0.3)*creatureSz*0.9,Math.sin(ta)*creatureSz*1.8);x1.stroke();}
    x1.shadowBlur=0;x1.restore();
  }
}
function drawStormChaser(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  const sg=x0.createRadialGradient(cx,cy*0.3,0,cx,h*0.5,h*0.8);const sc=h2r(pc(2));sg.addColorStop(0,`rgba(${sc.r},${sc.g},${sc.b},${0.15*progMult})`);sg.addColorStop(0.5,THEME.bgColor);sg.addColorStop(1,'rgba(0,0,0,0.9)');x0.fillStyle=sg;x0.fillRect(0,0,w,h);
  SD.tornadoA=(SD.tornadoA||0)+0.015*(1+SM.energy);
  for(let ring=0;ring<30;ring++){const z=ring/30,r=z*Math.min(w,h)*0.4*(1+SM.beatPulse*0.1),y2=cy*0.2+z*(h-cy*0.2);x0.beginPath();x0.ellipse(cx,y2,r*0.3,r*0.08,SD.tornadoA+ring*0.15,0,Math.PI*2);x0.strokeStyle=rgba(pc(ring%4),(1-z)*0.15*THEME.sceneIntensity);x0.lineWidth=1.5+z*2;x0.stroke();}
  if(SD.debris)for(const d of SD.debris){d.x+=d.vx*(1+SM.energy*0.5);d.y+=d.vy*(1+SM.energy*0.5);const dx=d.x-cx,dy=d.y-cy,dist=Math.sqrt(dx*dx+dy*dy);if(dist>0){d.x-=dy/dist*1.5;d.y+=dx/dist*1.5;}d.rot+=d.rotS;if(d.x<-60||d.x>w+60||d.y<-60||d.y>h+60)Object.assign(d,mkDebris());x0.save();x0.translate(d.x,d.y);x0.rotate(d.rot);x0.fillStyle=rgba(pc(d.ci),0.5);if(d.type===0)x0.fillRect(-d.sz/2,-d.sz*0.1,d.sz,d.sz*0.2);else{x0.beginPath();x0.arc(0,0,d.sz*0.3,0,Math.PI*2);x0.fill();}x0.restore();}
  // Storm worsens over song - more lightning, faster tornado, heavier rain
  const stormIntensity=0.2+songProg*0.8;
  SD.ltTimer=(SD.ltTimer||0)-16;
  const ltInterval=Math.max(100,600-songProg*400);
  if(SD.ltTimer<0&&SD.lightnings){SD.lightnings.push(mkLightning());if(stormIntensity>0.5)SD.lightnings.push(mkLightning());SD.ltTimer=ltInterval+Math.random()*300;}
  if(SD.lightnings)for(let i=SD.lightnings.length-1;i>=0;i--){const lt=SD.lightnings[i];lt.life-=0.08;if(lt.life<=0){SD.lightnings.splice(i,1);continue;}x0.shadowBlur=20*stormIntensity;x0.shadowColor=pc(lt.ci);for(const seg of lt.segs){x0.beginPath();x0.moveTo(seg.x1,seg.y1);x0.lineTo(seg.x2,seg.y2);x0.strokeStyle=rgba(pc(lt.ci),lt.life*stormIntensity);x0.lineWidth=lt.life*2;x0.stroke();}x0.shadowBlur=0;}
  const rainAlpha=0.1+stormIntensity*0.25;x0.strokeStyle=rgba(pc(2),rainAlpha);x0.lineWidth=0.8;
  for(let i=0;i<Math.floor(100+stormIntensity*200);i++){const rx=Math.random()*w,ry=Math.random()*h;x0.beginPath();x0.moveTo(rx,ry);x0.lineTo(rx-3*stormIntensity,ry+18);x0.stroke();}
  // Centerpiece orbiting the tornado at increasing speed
  if(THEME.centerpiece){
    cpOrbit+=0.015*(1+stormIntensity+SM.beatPulse*0.5);
    const tornadoX=cx,tornadoY=cy*1.2;
    const orbitR=Math.min(w,h)*(0.15+stormIntensity*0.1);
    const orbX=tornadoX+Math.cos(cpOrbit)*orbitR;
    const orbY=tornadoY+Math.sin(cpOrbit)*orbitR*0.4;
    x1.clearRect(0,0,w,h);x1.save();x1.translate(orbX,orbY);x1.rotate(cpRot);
    const osz=Math.min(w,h)*(0.05+SM.beatPulse*0.02);
    x1.globalAlpha=0.6+stormIntensity*0.4;
    x1.shadowBlur=osz;x1.shadowColor=pc(1);
    const og=x1.createRadialGradient(0,0,0,0,0,osz);og.addColorStop(0,'rgba(255,255,255,0.9)');og.addColorStop(0.4,rgba(pc(1),0.7));og.addColorStop(1,'transparent');x1.fillStyle=og;x1.beginPath();x1.arc(0,0,osz,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();cpRot+=0.05;
  }
}
function drawJungleRave(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  const gg=x0.createLinearGradient(0,h*0.7,0,h);gg.addColorStop(0,rgba(pc(2),0.2*(1+SM.beatPulse*0.3)));gg.addColorStop(1,'transparent');x0.fillStyle=gg;x0.fillRect(0,h*0.7,w,h*0.3);
  if(SD.plants)for(const pl of SD.plants){pl.ph+=0.01*(1+SM.beatPulse*0.5);const glm=pl.glowMult||1;x0.save();x0.translate(pl.x,h);x0.shadowBlur=15*glm;x0.shadowColor=pc(pl.ci);x0.strokeStyle=rgba(pc(pl.ci),0.7);function drawBranch(x2,y2,len,angle,depth){if(depth<1||len<8)return;const nx=x2+Math.cos(angle)*len,ny=y2-len;x0.beginPath();x0.moveTo(x2,y2);x0.lineTo(nx,ny);x0.lineWidth=depth*1.5;x0.stroke();const sw=0.4+Math.sin(pl.ph+depth)*0.2;drawBranch(nx,ny,len*0.65,angle-sw,depth-1);drawBranch(nx,ny,len*0.65,angle+sw,depth-1);}drawBranch(0,0,pl.sz*0.35,0,5);x0.restore();x0.shadowBlur=0;if(pl.glowMult>1)pl.glowMult*=0.98;}
  if(SD.creatures)for(let i=SD.creatures.length-1;i>=0;i--){const cr=SD.creatures[i];cr.x+=cr.vx*(1+SM.energy*0.3);cr.ph+=0.015;if(cr.x<-cr.sz*2){SD.creatures[i]=mkJungleCreature(w,h);continue;}x0.save();x0.translate(cr.x,cr.y+Math.sin(cr.ph)*cr.sz*0.1);x0.shadowBlur=40;x0.shadowColor=pc(cr.ci);const alpha=0.5*THEME.sceneIntensity*(1+SM.beatPulse*0.15);x0.fillStyle=rgba(pc(cr.ci),alpha*0.7);x0.beginPath();x0.ellipse(0,0,cr.sz*0.8,cr.sz*0.5,0,0,Math.PI*2);x0.fill();x0.shadowBlur=0;x0.restore();}
  if(SD.spores)for(const sp of SD.spores){sp.x+=sp.vx;sp.y+=sp.vy*(1+SM.energy*0.3);sp.ph+=0.05;if(sp.y<-5){sp.y=h+5;sp.x=Math.random()*w;}const br=Math.sin(sp.ph)*0.4+0.6;x0.beginPath();x0.arc(sp.x,sp.y,sp.r*br,0,Math.PI*2);x0.fillStyle=rgba(pc(sp.ci),br*0.6*(0.5+songProg));x0.shadowBlur=6*(0.5+songProg);x0.shadowColor=pc(sp.ci);x0.fill();x0.shadowBlur=0;}
  // Centerpiece glowing at treetop center
  if(THEME.centerpiece&&SD.plants&&SD.plants.length>0){
    const midTree=SD.plants[Math.floor(SD.plants.length/2)];
    x1.clearRect(0,0,w,h);x1.save();
    const treeCX=w/2,treeCY=h*(0.78-0.4*(0.5+songProg*0.5));
    x1.translate(treeCX,treeCY);x1.rotate(cpRot);
    const glowSz=Math.min(w,h)*(0.08+SM.beatPulse*0.06)*(0.5+songProg);
    x1.shadowBlur=glowSz*1.5;x1.shadowColor=pc(0);x1.globalAlpha=0.5+songProg*0.5;
    const rg=x1.createRadialGradient(0,0,0,0,0,glowSz);rg.addColorStop(0,rgba(pc(0),1));rg.addColorStop(0.5,rgba(pc(1),0.6));rg.addColorStop(1,'transparent');x1.fillStyle=rg;x1.beginPath();x1.arc(0,0,glowSz,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();cpRot+=0.02;
  }
}
function drawDiscoDimension(t){
  const w=W(),h=H(),vpy=h*0.5;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  SD.tileZ=(SD.tileZ||0)+THEME.sceneSpeed*0.008*(1+SM.energy*0.5)*(1+beatFX.speedBoost*0.5);
  for(let row=0;row<16;row++){const z=((row/16+SD.tileZ)%1),py=lerp(vpy,h,z),px1=lerp(w/2,0,z),px2=lerp(w/2,w,z),ci=Math.floor(row*4/16)%4;x0.strokeStyle=rgba(pc(ci),(0.1+z*0.6)*THEME.sceneIntensity*(1+SM.beatPulse*0.3));x0.lineWidth=1+z*2;x0.shadowBlur=z>0.6?8:0;x0.shadowColor=pc(ci);x0.beginPath();x0.moveTo(px1,py);x0.lineTo(px2,py);x0.stroke();x0.shadowBlur=0;}
  for(let col=0;col<=16;col++){const nx=(col/16-0.5)*2;x0.strokeStyle=rgba(pc(1),(Math.abs(nx)<0.2?0.4:0.15)*THEME.sceneIntensity);x0.lineWidth=0.5;x0.beginPath();x0.moveTo(w/2+nx*w*0.01,vpy);x0.lineTo(w/2+nx*w*0.5,h);x0.stroke();}
  if(SD.beams)for(const lb of SD.beams){lb.ph+=0.008*(1+SM.beatPulse*0.5);const lx=lb.x+Math.sin(lb.ph)*80;x0.save();x0.globalAlpha=0.05*(1+SM.beatPulse*0.4)*THEME.sceneIntensity;const lg=x0.createLinearGradient(lx,0,lx+20,h);const lc=h2r(pc(lb.ci));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;x0.beginPath();x0.moveTo(lx-5,0);x0.lineTo(lx+25,0);x0.lineTo(lx+60,h);x0.lineTo(lx-40,h);x0.closePath();x0.fill();x0.restore();}
  if(SD.chandeliers)for(const ch of SD.chandeliers){ch.rot+=ch.rotS*(1+SM.beatPulse*0.3);if(ch.drop){ch.y=Math.min(h*0.4,ch.y+h*0.005);}x0.save();x0.translate(ch.x,ch.y);x0.rotate(ch.rot);x0.shadowBlur=20;x0.shadowColor=pc(1);for(let row=0;row<6;row++)for(let col=0;col<8;col++){const lat=(row/6-0.5)*Math.PI,lon=col/8*Math.PI*2+ch.rot;const tx=Math.cos(lat)*Math.cos(lon)*ch.size,ty=Math.sin(lat)*ch.size,tz=Math.cos(lat)*Math.sin(lon);if(tz<0.1)continue;x0.fillStyle=rgba(pc((row+col)%4),(0.3+tz*0.6)*0.8);x0.fillRect(tx-3,ty-3,6,6);}x0.shadowBlur=0;x0.restore();for(let r=0;r<6;r++){const a=r/6*Math.PI*2+ch.rot*1.5;x0.beginPath();x0.moveTo(ch.x,ch.y);x0.lineTo(ch.x+Math.cos(a)*w,ch.y+Math.sin(a)*h*0.8);x0.strokeStyle=rgba(pc(r%4),0.03*(1+SM.beatPulse*0.4));x0.lineWidth=4;x0.stroke();}}
}
function drawAcidTrip(t){
  const w=W(),h=H();
  SD.fracPh=(SD.fracPh||0)+0.015*(1+SM.energy*0.3);SD.colorCyc=(SD.colorCyc||0)+0.008;
  const ci1=Math.floor(SD.colorCyc)%4,ci2=(Math.floor(SD.colorCyc)+1)%4,frac=SD.colorCyc%1;
  const ac=h2r(pc(ci1)),bc=h2r(pc(ci2));
  x0.fillStyle=`rgb(${Math.round(lerp(ac.r,bc.r,frac)*0.07)},${Math.round(lerp(ac.g,bc.g,frac)*0.07)},${Math.round(lerp(ac.b,bc.b,frac)*0.07)})`;x0.fillRect(0,0,w,h);
  if(!SD.warpGrid)return;
  const gw=w/20,gh=h/14;
  for(const gp of SD.warpGrid){gp.ph+=0.02*(1+SM.energy*0.2);const wx=gp.gx*gw+Math.sin(gp.ph+gp.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy=gp.gy*gh+Math.cos(gp.ph+gp.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const gc=Math.floor((gp.gx+gp.gy+SD.colorCyc)%4);x0.fillStyle=rgba(pc(gc),0.5*THEME.sceneIntensity);x0.fillRect(wx-2,wy-2,4,4);}
  for(let gx=0;gx<19;gx++)for(let gy=0;gy<13;gy++){const p1=SD.warpGrid[gy*20+gx],p2=SD.warpGrid[gy*20+gx+1],p3=SD.warpGrid[(gy+1)*20+gx];if(!p1||!p2||!p3)continue;const wx1=p1.gx*gw+Math.sin(p1.ph+p1.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy1=p1.gy*gh+Math.cos(p1.ph+p1.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const wx2=p2.gx*gw+Math.sin(p2.ph+p2.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy2=p2.gy*gh+Math.cos(p2.ph+p2.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const wx3=p3.gx*gw+Math.sin(p3.ph+p3.gy*0.5)*gw*0.7*(0.5+SD.fracPh%1),wy3=p3.gy*gh+Math.cos(p3.ph+p3.gx*0.3)*gh*0.7*(0.5+SD.fracPh%1);const gc=Math.floor((gx+gy+SD.colorCyc)%4);x0.strokeStyle=rgba(pc(gc),0.2*THEME.sceneIntensity);x0.lineWidth=1;x0.beginPath();x0.moveTo(wx1,wy1);x0.lineTo(wx2,wy2);x0.stroke();x0.beginPath();x0.moveTo(wx1,wy1);x0.lineTo(wx3,wy3);x0.stroke();}
  x0.save();x0.translate(w/2,h/2);for(let seg=0;seg<8;seg++){const r=SD.fracPh+seg/8*Math.PI*2;for(let ri=0;ri<5;ri++){x0.beginPath();x0.arc(0,0,ri*60+SM.beatPulse*20,r,r+Math.PI*2*0.9/8);x0.strokeStyle=rgba(pc((ri+seg)%4),(0.3-ri*0.04)*THEME.sceneIntensity*(1+SM.beatPulse*0.3));x0.lineWidth=3-ri*0.4;x0.stroke();}}x0.restore();
  // Centerpiece melts and warps into grid — appears as distorted ghost in the geometry
  if(THEME.centerpiece){
    const melt=Math.min(1,songProg*1.4);
    x1.clearRect(0,0,w,h);x1.save();
    x1.translate(w/2+Math.sin(SD.fracPh*1.3)*w*0.15*melt,h/2+Math.cos(SD.fracPh)*h*0.1*melt);
    x1.rotate(cpRot+SD.fracPh*melt);
    x1.scale(1+Math.sin(SD.fracPh*2)*0.3*melt,1+Math.cos(SD.fracPh*1.5)*0.3*melt);
    const ms=Math.min(w,h)*(0.12+SM.beatPulse*0.04);
    x1.globalAlpha=(0.12+SM.beatPulse*0.08)*(1+melt*0.5);
    x1.shadowBlur=ms*1.5*melt;x1.shadowColor=pc(Math.floor(SD.colorCyc)%4);
    const mg=x1.createRadialGradient(0,0,0,0,0,ms);mg.addColorStop(0,rgba(pc(Math.floor(SD.colorCyc)%4),0.8));mg.addColorStop(0.5,rgba(pc((Math.floor(SD.colorCyc)+1)%4),0.4));mg.addColorStop(1,'transparent');x1.fillStyle=mg;x1.beginPath();x1.arc(0,0,ms,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();cpRot+=0.02*(1+melt);
  }
}
function drawSpaceStation(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  const earthR=Math.min(w,h)*0.38;const eg=x0.createRadialGradient(w*0.12,h*0.88,0,w*0.12,h*0.88,earthR);const ec=h2r(pc(2));eg.addColorStop(0,`rgba(${ec.r},${ec.g},${ec.b},0.7)`);eg.addColorStop(0.7,'transparent');x0.fillStyle=eg;x0.fillRect(0,h*0.4,earthR*2,h);
  // Station hull panels - appear and glow as song progresses
  const hullAlpha=songProg*0.2+SM.beatPulse*0.05;
  x0.strokeStyle=rgba(pc(0),hullAlpha);x0.lineWidth=1;
  for(let px2=0;px2<w;px2+=80)for(let py2=0;py2<h;py2+=60){x0.strokeRect(px2,py2,80,60);}
  // Alert flicker as song peaks
  if(songProg>0.6&&SM.beatPulse>0.4){x0.fillStyle=rgba(pc(2),0.04*SM.beatPulse);x0.fillRect(0,0,w,h);}
  if(!SD.stars)return;
  for(const s of SD.stars){s.z-=0.0006*THEME.sceneSpeed*(1+beatFX.speedBoost*0.5);if(s.z<0.01){s.z=1;s.x=(Math.random()-0.5)*2;s.y=(Math.random()-0.5)*2;s.trail=[];}const px=cx+(s.x/s.z)*cx,py=cy+(s.y/s.z)*cy;if(px<-20||px>w+20||py<-20||py>h+20)continue;const sz=(1-s.z)*3+0.3;x0.beginPath();x0.arc(px,py,sz,0,Math.PI*2);x0.fillStyle=rgba(pc(s.ci),(1-s.z)*0.8);x0.fill();}
  if(SD.debris)for(const d of SD.debris){d.x+=d.vx*(1+songProg*0.3);d.y+=d.vy;d.rot+=d.rotS;if(d.x<-60)d.x=w+60;if(d.x>w+60)d.x=-60;if(d.y<-60)d.y=h+60;if(d.y>h+60)d.y=-60;x0.save();x0.translate(d.x,d.y);x0.rotate(d.rot);x0.fillStyle=rgba(pc(d.ci),0.4+songProg*0.2);x0.shadowBlur=songProg>0.5?8:0;x0.shadowColor=pc(d.ci);x0.fillRect(-d.sz/2,-d.sz*0.2,d.sz,d.sz*0.4);x0.shadowBlur=0;x0.restore();}
  // Hull breach effect - centerpiece as debris field symbol
  if(THEME.centerpiece&&SD.hullBreachActive){
    x1.clearRect(0,0,w,h);x1.save();x1.translate(cx,cy);x1.rotate(cpRot);
    x1.globalAlpha=0.15+SM.beatPulse*0.1;x1.shadowBlur=40;x1.shadowColor=pc(2);
    const bs=Math.min(w,h)*0.3;
    x1.strokeStyle=rgba(pc(2),0.6);x1.lineWidth=3;x1.beginPath();x1.arc(0,0,bs,0,Math.PI*2);x1.stroke();
    for(let sp=0;sp<8;sp++){const sa=sp/8*Math.PI*2;x1.beginPath();x1.moveTo(Math.cos(sa)*bs*0.5,Math.sin(sa)*bs*0.5);x1.lineTo(Math.cos(sa)*bs*1.3,Math.sin(sa)*bs*1.3);x1.strokeStyle=rgba(pc(sp%4),0.4);x1.lineWidth=2;x1.stroke();}
    x1.shadowBlur=0;x1.restore();cpRot+=0.01;
  }
}
// Track hull breach state
if(typeof SD.hullBreachActive==='undefined'){}
function drawNeonCathedral(t){
  const w=W(),h=H(),cx=w/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  // Ray intensity grows over song like sunlight through stained glass increasing
  const holyLight=0.4+songProg*0.8;
  if(SD.rays)for(const lr of SD.rays){lr.ph+=0.003;const lx=lr.x+Math.sin(lr.ph)*30;x0.save();x0.globalAlpha=lr.alpha*(0.6+Math.sin(lr.ph)*0.4)*THEME.sceneIntensity*(1+SM.beatPulse*0.4)*holyLight;const lg=x0.createLinearGradient(lx,0,lx,h*0.7);const lc=h2r(pc(Math.floor(lr.ph*0.5)%4));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;x0.beginPath();x0.moveTo(lx-lr.width*0.3,0);x0.lineTo(lx+lr.width*0.7,0);x0.lineTo(lx+lr.width*2,h*0.7);x0.lineTo(lx-lr.width*1.5,h*0.7);x0.closePath();x0.fill();x0.restore();}
  if(SD.arches)for(const arch of SD.arches){const depth=1-arch.depth,archW=w*(arch.width),archH=h*(0.5+arch.depth*0.4);x0.strokeStyle=rgba(pc(arch.ci),(0.1+depth*0.5)*THEME.sceneIntensity*(1+SM.beatPulse*0.2)*holyLight);x0.lineWidth=1+depth*3;x0.shadowBlur=15*depth*holyLight;x0.shadowColor=pc(arch.ci);x0.beginPath();x0.moveTo(cx-archW*0.5,h);x0.lineTo(cx-archW*0.5,h-archH*0.4);x0.bezierCurveTo(cx-archW*0.5,h-archH,cx-archW*0.05,h-archH,cx,h-archH);x0.stroke();x0.beginPath();x0.moveTo(cx+archW*0.5,h);x0.lineTo(cx+archW*0.5,h-archH*0.4);x0.bezierCurveTo(cx+archW*0.5,h-archH,cx+archW*0.05,h-archH,cx,h-archH);x0.stroke();x0.shadowBlur=0;}
  if(SD.motes)for(const p of SD.motes){p.y+=p.vy*(0.5+holyLight*0.5);p.ph+=0.05;if(p.y<-5){p.y=h+5;p.x=Math.random()*w;}const br=Math.sin(p.ph)*0.4+0.6;x0.beginPath();x0.arc(p.x,p.y,p.r,0,Math.PI*2);x0.fillStyle=rgba(pc(p.ci),br*0.6*THEME.sceneIntensity*holyLight);x0.shadowBlur=6;x0.shadowColor=pc(p.ci);x0.fill();x0.shadowBlur=0;}
  // Centerpiece as rose window at top center — mandala-like radiating symbol
  if(THEME.centerpiece){
    x1.clearRect(0,0,w,h);x1.save();
    x1.translate(cx,h*0.12);x1.rotate(cpRot);
    const rw=Math.min(w,h)*(0.12+SM.beatPulse*0.04)*(0.6+holyLight*0.6);
    x1.globalAlpha=0.3+holyLight*0.4+SM.beatPulse*0.15;
    x1.shadowBlur=rw*0.8*holyLight;x1.shadowColor=pc(0);
    // Rose window rings
    for(let ring=4;ring>0;ring--){const ri=ring/4;x1.beginPath();x1.arc(0,0,rw*ri,0,Math.PI*2);x1.strokeStyle=rgba(pc(ring%4),0.4*(1+SM.beatPulse*0.3));x1.lineWidth=rw*0.04;x1.stroke();}
    // Spokes
    for(let s2=0;s2<12;s2++){const sa=s2/12*Math.PI*2;x1.beginPath();x1.moveTo(0,0);x1.lineTo(Math.cos(sa)*rw,Math.sin(sa)*rw);x1.strokeStyle=rgba(pc(s2%4),0.3);x1.lineWidth=1.5;x1.stroke();}
    x1.beginPath();x1.arc(0,0,rw*0.2,0,Math.PI*2);x1.fillStyle=rgba(pc(0),0.8);x1.fill();
    x1.shadowBlur=0;x1.restore();cpRot+=0.004;
  }
}
function drawClassicArcade(t){
  const w=W(),h=H();
  x0.fillStyle='#000';x0.fillRect(0,0,w,h);
  x0.strokeStyle=rgba(pc(0),0.05);x0.lineWidth=1;for(let gx=0;gx<w;gx+=32){x0.beginPath();x0.moveTo(gx,0);x0.lineTo(gx,h);x0.stroke();}for(let gy=0;gy<h;gy+=32){x0.beginPath();x0.moveTo(0,gy);x0.lineTo(w,gy);x0.stroke();}
  if(SD.mazeLines)for(const ml of SD.mazeLines){x0.beginPath();x0.moveTo(ml.x1,ml.y1);x0.lineTo(ml.x2,ml.y2);x0.strokeStyle=rgba(pc(ml.ci),0.3);x0.lineWidth=3;x0.shadowBlur=8;x0.shadowColor=pc(ml.ci);x0.stroke();x0.shadowBlur=0;}
  if(SD.pixels)for(const p of SD.pixels){p.x+=p.vx*(1+SM.energy*0.5);p.y+=p.vy*(1+SM.energy*0.5);if(p.x<0||p.x>w)p.vx*=-1;if(p.y<0||p.y>h)p.vy*=-1;x0.shadowBlur=10;x0.shadowColor=pc(p.ci);x0.fillStyle=rgba(pc(p.ci),0.85);x0.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size);x0.shadowBlur=0;}
  SD.scanLine=(SD.scanLine+3)%h;x0.fillStyle='rgba(255,255,255,0.015)';x0.fillRect(0,SD.scanLine,w,2);
  const cvg=x0.createRadialGradient(w/2,h/2,h*0.3,w/2,h/2,h*0.75);cvg.addColorStop(0,'transparent');cvg.addColorStop(1,'rgba(0,0,0,0.6)');x0.fillStyle=cvg;x0.fillRect(0,0,w,h);
}
function drawElectricForest(t){
  const w=W(),h=H();
  const fantasy=Math.min(1,songProg*1.5);
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  const gg=x0.createLinearGradient(0,h*0.75,0,h);gg.addColorStop(0,rgba(pc(2),0.2*(1+SM.beatPulse*0.3)));gg.addColorStop(1,'transparent');x0.fillStyle=gg;x0.fillRect(0,h*0.75,w,h*0.25);
  if(SD.trees)for(const tr of SD.trees){tr.ph+=0.008;const glm=tr.glowMult||1;x0.save();x0.translate(tr.x,h*0.78);x0.shadowBlur=20*(fantasy+0.3)*glm;x0.shadowColor=pc(tr.ci);x0.strokeStyle=rgba(pc(tr.ci),0.6+fantasy*0.3);function drawTree(x2,y2,len,angle,depth){if(depth<1||len<8)return;const nx=x2+Math.cos(angle)*len,ny=y2-len;x0.beginPath();x0.moveTo(x2,y2);x0.lineTo(nx,ny);x0.lineWidth=depth*1.5;x0.stroke();drawTree(nx,ny,len*0.65,angle-0.45+Math.sin(tr.ph)*0.1,depth-1);drawTree(nx,ny,len*0.65,angle+0.45+Math.sin(tr.ph+1)*0.1,depth-1);}drawTree(0,0,tr.sz*0.4,0,5);x0.restore();if(tr.glowMult>1)tr.glowMult*=0.99;}
  for(let i=0;SD.trees&&i<SD.trees.length-1;i++){const t1=SD.trees[i],t2=SD.trees[i+1];for(let j=0;j<8;j++){const jx=lerp(t1.x,t2.x,j/7),jy=h*0.5+Math.sin(j/7*Math.PI)*40;x0.beginPath();x0.arc(jx,jy,2+SM.beatPulse*2,0,Math.PI*2);x0.fillStyle=rgba(pc((i+j)%4),0.7+SM.beatPulse*0.3);x0.shadowBlur=8;x0.shadowColor=pc((i+j)%4);x0.fill();x0.shadowBlur=0;}}
  if(fantasy>0.3&&SD.mushrooms)for(const m of SD.mushrooms){m.ph+=0.01;x0.save();x0.translate(m.x,h*0.78);x0.shadowBlur=20*fantasy;x0.shadowColor=pc(m.ci);x0.fillStyle=rgba(pc(m.ci),fantasy*0.8);x0.beginPath();x0.ellipse(0,-m.sz*0.6,m.sz*0.5,m.sz*0.35,0,0,Math.PI*2);x0.fill();x0.fillStyle=rgba(pc((m.ci+1)%4),fantasy*0.6);x0.fillRect(-m.sz*0.1,-m.sz*0.25,m.sz*0.2,m.sz*0.3);x0.restore();}
  if(SD.fairies)for(const f of SD.fairies){f.x+=f.vx+Math.sin(t*0.001+f.ph)*0.5;f.y+=f.vy+Math.cos(t*0.0008+f.ph)*0.5;f.ph+=0.06;if(f.x<0||f.x>w)f.vx*=-1;if(f.y<0||f.y>h)f.vy*=-1;const br=Math.sin(f.ph)*0.4+0.6;x0.beginPath();x0.arc(f.x,f.y,f.r*(0.6+br*0.6),0,Math.PI*2);x0.fillStyle=rgba(pc(f.ci),br*(0.4+fantasy*0.5));x0.shadowBlur=12*fantasy;x0.shadowColor=pc(f.ci);x0.fill();x0.shadowBlur=0;}
}
function drawOmniaNightclub(t){
  const w=W(),h=H(),cx=w/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  for(let tier=0;tier<3;tier++){x0.fillStyle=rgba(pc(tier),0.05);x0.fillRect(0,h*0.5+tier*h*0.12,w,h*0.12);x0.strokeStyle=rgba(pc(tier),0.12);x0.lineWidth=1;x0.beginPath();x0.moveTo(0,h*0.5+tier*h*0.12);x0.lineTo(w,h*0.5+tier*h*0.12);x0.stroke();}
  if(SD.chandelierY==null)SD.chandelierY=h*0.02;
  // Chandelier slowly descends over the song — massive, fills top 40%
  const targetChanY=h*(0.05+songProg*0.32);
  SD.chandelierY+=(targetChanY-SD.chandelierY)*0.002;
  const chanSize=Math.min(w,h)*(0.22+SM.beatPulse*0.04); // MASSIVE
  SD.chandelierRot=(SD.chandelierRot||0)+0.008*(1+SM.beatPulse*0.5);
  // Chain from ceiling
  x0.beginPath();x0.moveTo(cx,0);x0.lineTo(cx,SD.chandelierY-chanSize*0.5);x0.strokeStyle='rgba(255,255,255,0.3)';x0.lineWidth=3;x0.stroke();
  // Wide light beams from chandelier
  if(SD.beams)for(const b of SD.beams){b.ph+=0.006*(1+SM.beatPulse*0.4);const bx=cx+Math.cos(b.angle+b.ph*0.3)*chanSize*0.4;const endX=cx+Math.cos(b.angle+b.ph)*b.len*1.3;const endY=SD.chandelierY+b.len*1.1;const bg=x0.createLinearGradient(bx,SD.chandelierY,endX,endY);const bc=h2r(pc(b.ci));bg.addColorStop(0,`rgba(${bc.r},${bc.g},${bc.b},${0.1*(1+SM.beatPulse*0.5)})`);bg.addColorStop(1,'transparent');x0.strokeStyle=bg;x0.lineWidth=6;x0.beginPath();x0.moveTo(bx,SD.chandelierY);x0.lineTo(endX,endY);x0.stroke();}
  // Chandelier sphere - BIG
  x0.save();x0.translate(cx,SD.chandelierY);x0.rotate(SD.chandelierRot);x0.shadowBlur=60*(1+SM.beatPulse*0.5);x0.shadowColor=pc(0);
  for(let r=0;r<12;r++)for(let c=0;c<20;c++){const lat=(r/12-0.5)*Math.PI,lon=c/20*Math.PI*2;const tx=Math.cos(lat)*Math.cos(lon)*chanSize,ty=Math.sin(lat)*chanSize,tz=Math.cos(lat)*Math.sin(lon);if(tz<0.1)continue;const tsz=(8+tz*6)*(1+SM.beatPulse*0.15);x0.fillStyle=rgba(pc((r+c)%4),(0.4+tz*0.6)*0.9*(0.5+tz*0.5)*(1+SM.beatPulse*0.2));x0.fillRect(tx-tsz/2,ty-tsz/2,tsz,tsz);}x0.shadowBlur=0;x0.restore();
  // Centerpiece symbols orbit the chandelier as hanging ornaments
  if(THEME.centerpiece){
    x1.clearRect(0,0,w,h);
    for(let orn=0;orn<8;orn++){
      const oa=orn/8*Math.PI*2+SD.chandelierRot*2;
      const orR=chanSize*(0.8+Math.sin(oa*2)*0.1);
      const ox=cx+Math.cos(oa)*orR;
      const oy=SD.chandelierY+chanSize*0.4+Math.sin(oa*1.3)*chanSize*0.2;
      x1.save();x1.translate(ox,oy);x1.rotate(cpRot+orn);
      const os=Math.min(w,h)*(0.025+SM.beatPulse*0.01);
      x1.globalAlpha=0.7+SM.beatPulse*0.2;x1.shadowBlur=os*2;x1.shadowColor=pc(orn%4);
      const og=x1.createRadialGradient(0,0,0,0,0,os);og.addColorStop(0,rgba(pc(orn%4),0.9));og.addColorStop(1,'transparent');x1.fillStyle=og;x1.beginPath();x1.arc(0,0,os,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();
    }
    cpRot+=0.02;
  }
  if(SD.crowdPeople)for(const p of SD.crowdPeople){p.ph+=0.04*(1+SM.beatPulse*0.3);const swing=Math.sin(p.ph)*p.sz*0.3*(1+SM.beatPulse*0.4);x0.fillStyle=rgba(pc(p.ci),0.35*(1+SM.beatPulse*0.1));x0.fillRect(p.x-p.sz*0.15,p.y-p.sz*0.8+swing,p.sz*0.3,p.sz*0.8);x0.beginPath();x0.arc(p.x,p.y-p.sz*0.88+swing,p.sz*0.18,0,Math.PI*2);x0.fill();}
}
function drawPirateShip(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(SD.stars)for(const s of SD.stars){x0.fillStyle=`rgba(255,255,255,${s.br*0.8})`;x0.fillRect(s.x,s.y,1.5,1.5);}
  const hor=h*0.6;
  if(SD.waves)for(let wv=0;wv<5;wv++){const wave=SD.waves[wv];wave.ph+=wave.speed*(1+SM.energy*0.3);x0.beginPath();for(let px=0;px<=w;px+=4){const py=hor+wv*25+Math.sin(px*0.01+wave.ph)*wave.amp*(1+SM.beatPulse*0.2);px===0?x0.moveTo(px,py):x0.lineTo(px,py);}x0.lineTo(w,h);x0.lineTo(0,h);x0.closePath();const wg=x0.createLinearGradient(0,hor,0,h);const wc=h2r(pc(wv%4));wg.addColorStop(0,`rgba(${wc.r},${wc.g},${wc.b},${0.3*(1+SM.beatPulse*0.2)})`);wg.addColorStop(1,'rgba(0,20,60,0.9)');x0.fillStyle=wg;x0.fill();}
  x0.fillStyle='rgba(20,10,5,0.95)';x0.beginPath();x0.moveTo(w*0.1,hor*0.98);x0.lineTo(w*0.9,hor*0.98);x0.lineTo(w*0.85,h*0.55);x0.lineTo(w*0.15,h*0.55);x0.closePath();x0.fill();
  x0.strokeStyle='rgba(40,20,5,0.9)';x0.lineWidth=8;x0.beginPath();x0.moveTo(w*0.35,h*0.55);x0.lineTo(w*0.35,h*0.05);x0.stroke();x0.beginPath();x0.moveTo(w*0.65,h*0.55);x0.lineTo(w*0.65,h*0.12);x0.stroke();
  x0.fillStyle=rgba(pc(1),0.3+SM.beatPulse*0.1);x0.beginPath();x0.moveTo(w*0.35,h*0.08);x0.lineTo(w*0.52,h*0.18+Math.sin(t*0.001)*10);x0.lineTo(w*0.35,h*0.38);x0.closePath();x0.fill();x0.beginPath();x0.moveTo(w*0.65,h*0.15);x0.lineTo(w*0.82,h*0.25+Math.sin(t*0.001)*10);x0.lineTo(w*0.65,h*0.45);x0.closePath();x0.fill();
  // Centerpiece emblem on main sail
  if(THEME.centerpiece){
    x1.clearRect(0,0,w,h);x1.save();
    const sailCX=w*0.43,sailCY=h*0.22+Math.sin(t*0.001)*5;
    x1.translate(sailCX,sailCY);x1.rotate(cpRot);
    const emblemSz=Math.min(w,h)*(0.06+SM.beatPulse*0.015);
    x1.globalAlpha=0.6+SM.beatPulse*0.2;x1.shadowBlur=emblemSz;x1.shadowColor=pc(2);
    const eg2=x1.createRadialGradient(0,0,0,0,0,emblemSz);eg2.addColorStop(0,rgba(pc(2),0.9));eg2.addColorStop(0.6,rgba(pc(0),0.5));eg2.addColorStop(1,'transparent');x1.fillStyle=eg2;x1.beginPath();x1.arc(0,0,emblemSz,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();cpRot+=0.005;
  }
  if(SD.seagulls)for(const sg of SD.seagulls){sg.x+=sg.vx;sg.ph+=0.08;if(sg.x>w+20)sg.x=-20;x0.beginPath();x0.moveTo(sg.x-10,sg.y+Math.sin(sg.ph)*3);x0.quadraticCurveTo(sg.x,sg.y-5,sg.x+10,sg.y+Math.sin(sg.ph)*3);x0.strokeStyle='rgba(255,255,255,0.5)';x0.lineWidth=1.5;x0.stroke();}
  if(SD.cannonballs)for(let i=SD.cannonballs.length-1;i>=0;i--){const cb=SD.cannonballs[i];cb.x+=cb.vx;cb.y+=cb.vy;cb.vy+=0.3;cb.life-=0.02;if(cb.life<=0||cb.y>h){SD.cannonballs.splice(i,1);continue;}x0.beginPath();x0.arc(cb.x,cb.y,cb.r,0,Math.PI*2);x0.fillStyle=rgba(pc(0),cb.life*0.9);x0.shadowBlur=15;x0.shadowColor=pc(0);x0.fill();x0.shadowBlur=0;}
}
function drawJunkyard(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  const ig=x0.createLinearGradient(0,0,0,h*0.5);ig.addColorStop(0,rgba(pc(1),0.1));ig.addColorStop(1,'transparent');x0.fillStyle=ig;x0.fillRect(0,0,w,h*0.5);
  x0.fillStyle='rgba(20,15,10,0.9)';x0.fillRect(0,h*0.7,w,h*0.3);
  if(SD.carStacks)for(const cs of SD.carStacks){const cx2=cs.x*w;for(let c=0;c<cs.cars;c++){const cy2=h*0.7-(c+1)*h*0.08;const cw=w*0.08,ch2=h*0.07;x0.fillStyle=rgba(pc(cs.ci),0.3+c*0.05);x0.fillRect(cx2-cw/2,cy2,cw,ch2);x0.strokeStyle=rgba(pc(cs.ci),0.5);x0.lineWidth=1;x0.strokeRect(cx2-cw/2,cy2,cw,ch2);}}
  if(SD.arms)for(const arm of SD.arms){arm.angle+=(arm.targetAngle-arm.angle)*arm.speed;if(Math.abs(arm.angle-arm.targetAngle)<0.05)arm.targetAngle=-Math.PI*0.3-Math.random()*0.5;x0.save();x0.translate(arm.x,arm.baseY);x0.strokeStyle=rgba(pc(arm.ci),0.7);x0.lineWidth=8;x0.lineCap='round';const ax=Math.cos(arm.angle)*arm.sz,ay=Math.sin(arm.angle)*arm.sz;x0.beginPath();x0.moveTo(0,0);x0.lineTo(ax,ay);x0.stroke();x0.lineCap='butt';x0.shadowBlur=15;x0.shadowColor=pc(arm.ci);x0.fillStyle=rgba(pc(arm.ci),0.8);x0.beginPath();x0.arc(ax,ay,8,0,Math.PI*2);x0.fill();x0.shadowBlur=0;x0.restore();}
  if(SD.sparks)for(let i=SD.sparks.length-1;i>=0;i--){const sp=SD.sparks[i];sp.x+=sp.vx;sp.y+=sp.vy;sp.vy+=0.4;sp.life-=0.025;if(sp.life<=0){SD.sparks.splice(i,1);continue;}x0.beginPath();x0.arc(sp.x,sp.y,2*sp.life,0,Math.PI*2);x0.fillStyle=rgba(pc(sp.ci),sp.life*0.9);x0.shadowBlur=6;x0.shadowColor=pc(sp.ci);x0.fill();x0.shadowBlur=0;}
  // Centerpiece as wrecking ball on crane arm - swings and smashes
  if(THEME.centerpiece){
    const armX=W()*0.6,armY=H()*0.1;
    const swingAng=Math.sin(t*0.0012*(1+songProg))*0.9*(1+SM.beatPulse*0.3);
    const chainLen=H()*(0.25+songProg*0.15);
    const ballX=armX+Math.sin(swingAng)*chainLen;
    const ballY=armY+Math.cos(swingAng)*chainLen;
    const ballR=Math.min(W(),H())*(0.06+SM.beatPulse*0.025);
    x1.clearRect(0,0,W(),H());x1.save();
    // Chain
    x1.strokeStyle='rgba(180,160,100,0.6)';x1.lineWidth=4;
    x1.setLineDash([6,4]);x1.beginPath();x1.moveTo(armX,armY);x1.lineTo(ballX,ballY);x1.stroke();x1.setLineDash([]);
    // Ball glow
    x1.shadowBlur=ballR*1.2;x1.shadowColor=pc(0);
    const bg=x1.createRadialGradient(-ballR*0.3,-ballR*0.3,0,0,0,ballR);bg.addColorStop(0,'rgba(220,200,100,1)');bg.addColorStop(0.5,rgba(pc(0),0.8));bg.addColorStop(1,rgba(pc(1),0.3));
    x1.translate(ballX,ballY);x1.fillStyle=bg;x1.beginPath();x1.arc(0,0,ballR,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();
    cpRot+=0.03;
    // Smash effect - when ball swings to extreme, shoot sparks
    if(Math.abs(swingAng)>0.75&&SD.sparks&&Math.random()<0.3){SD.sparks.push({x:ballX,y:ballY,vx:(Math.random()-0.5)*12,vy:-(Math.random()*6+2),life:0.8,ci:Math.floor(Math.random()*4)});}
  }
}
function drawSuperhero(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(SD.cityBuildings)for(const b of SD.cityBuildings){const by=h-b.h;x0.fillStyle=rgba(pc(b.ci),0.1);x0.fillRect(b.x,by,b.w,b.h);x0.strokeStyle=rgba(pc(b.ci),0.25+SM.beatPulse*0.1);x0.lineWidth=1;x0.strokeRect(b.x,by,b.w,b.h);if(b.windows)for(const wn of b.windows){if(!wn.on)continue;x0.fillStyle=rgba(pc(b.ci),0.65);x0.fillRect(b.x+wn.x,by+wn.y,9,11);}}
  SD.spotlightA=(SD.spotlightA||0)+(SM.beatPulse-SD.spotlightA)*0.1;
  const sl=x0.createRadialGradient(w/2,h,0,w/2,h,h*0.9);const sc=h2r(pc(0));sl.addColorStop(0,`rgba(${sc.r},${sc.g},${sc.b},${0.08*(1+SD.spotlightA*0.3)})`);sl.addColorStop(1,'transparent');x0.fillStyle=sl;x0.fillRect(0,0,w,h);
  x0.fillStyle='rgba(0,0,0,0.9)';x0.beginPath();x0.ellipse(w/2,h*0.35,30,35,0,0,Math.PI*2);x0.fill();x0.fillRect(w/2-20,h*0.35,40,70);
  x0.fillStyle=rgba(pc(0),0.6+SM.beatPulse*0.2);x0.beginPath();x0.moveTo(w/2-15,h*0.42);x0.bezierCurveTo(w/2-60,h*0.5+Math.sin(t*0.002)*20,w/2-80,h*0.65,w/2-30,h*0.7);x0.lineTo(w/2,h*0.68);x0.closePath();x0.fill();
}
function drawDayOfDead(t){
  const w=W(),h=H();
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(SD.petals)for(const p of SD.petals){p.x+=p.vx;p.y+=p.vy*(1+SM.energy*0.2);p.rot+=p.rotS;if(p.y>h+10){p.y=-10;p.x=Math.random()*w;}x0.save();x0.translate(p.x,p.y);x0.rotate(p.rot);x0.fillStyle=rgba(pc(p.ci),0.7);x0.beginPath();x0.ellipse(0,0,p.sz,p.sz*0.4,0,0,Math.PI*2);x0.fill();x0.restore();}
  x0.fillStyle='rgba(30,10,5,0.8)';x0.fillRect(0,h*0.72,w,h*0.28);
  if(SD.candles)for(const c of SD.candles){c.flicker+=0.08;const fx=Math.sin(c.flicker)*3,tx=c.x;x0.fillStyle='rgba(200,180,100,0.8)';x0.fillRect(tx-c.sz*0.12,h*0.62,c.sz*0.25,c.sz*1.2);const fg=x0.createRadialGradient(tx+fx,h*0.6,0,tx+fx,h*0.6,c.sz*(0.8+Math.sin(c.flicker)*0.2));fg.addColorStop(0,'rgba(255,220,80,0.9)');fg.addColorStop(0.3,rgba(pc(1),0.4));fg.addColorStop(1,'transparent');x0.fillStyle=fg;x0.fillRect(0,0,w,h);}
  if(SD.skulls)for(const sk of SD.skulls){sk.ph+=0.008;x0.save();x0.translate(sk.x,sk.y+Math.sin(sk.ph)*10);x0.shadowBlur=20;x0.shadowColor=pc(sk.ci);x0.fillStyle=rgba(pc(sk.ci),0.7*(1+SM.beatPulse*0.2));x0.beginPath();x0.ellipse(0,0,sk.sz*0.6,sk.sz*0.65,0,0,Math.PI*2);x0.fill();x0.fillStyle=rgba(pc((sk.ci+2)%4),0.9);for(const[ex,ey]of[[-sk.sz*0.22,-sk.sz*0.1],[sk.sz*0.22,-sk.sz*0.1]]){x0.beginPath();x0.arc(ex,ey,sk.sz*0.18,0,Math.PI*2);x0.fill();}for(let f=0;f<5;f++){const fa=f/5*Math.PI*2+sk.ph;x0.fillStyle=rgba(pc((sk.ci+f)%4),0.8);x0.beginPath();x0.arc(Math.cos(fa)*sk.sz*0.5,Math.sin(fa)*sk.sz*0.5,sk.sz*0.1,0,Math.PI*2);x0.fill();}x0.shadowBlur=0;x0.restore();}
}
function drawChineseDragon(t){
  const w=W(),h=H(),hx=w/2,hy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  if(SD.fog)for(const fg of SD.fog){fg.ph+=fg.speed;const fx=fg.x+Math.sin(fg.ph)*50,fy=fg.y+Math.cos(fg.ph*0.7)*30;const gr=x0.createRadialGradient(fx,fy,0,fx,fy,fg.r);const gc=h2r(pc(1));gr.addColorStop(0,`rgba(${gc.r},${gc.g},${gc.b},0.06)`);gr.addColorStop(1,'transparent');x0.fillStyle=gr;x0.fillRect(0,0,w,h);}
  SD.dragonEmerge=Math.min(1,(SD.dragonEmerge||0)+0.005*(1+SM.energy*0.3));
  const emerge=SD.dragonEmerge;
  x0.save();x0.globalAlpha=emerge;x0.shadowBlur=40;x0.shadowColor=pc(0);
  for(let s=0;s<20;s++){const sx=hx+Math.cos(t*0.001+s*0.4)*w*(0.05+s*0.015),sy=hy+Math.sin(t*0.0008+s*0.3)*h*(0.03+s*0.01);const segR=28*(1-s/20)*emerge;if(segR<1)continue;x0.beginPath();x0.arc(sx,sy,segR,0,Math.PI*2);x0.fillStyle=rgba(pc(s%4),(0.6-s*0.025)*Math.min(1,emerge*2));x0.fill();}
  x0.fillStyle=rgba(pc(0),0.85*emerge);x0.beginPath();x0.ellipse(hx,hy,110*(1+SM.beatPulse*0.15),80*(1+SM.beatPulse*0.15),0,0,Math.PI*2);x0.fill();
  x0.strokeStyle=rgba(pc(2),0.8*emerge);x0.lineWidth=4;x0.beginPath();x0.moveTo(hx-60,hy-80);x0.bezierCurveTo(hx-80,hy-120,hx-40,hy-150,hx-20,hy-100);x0.stroke();x0.beginPath();x0.moveTo(hx+60,hy-80);x0.bezierCurveTo(hx+80,hy-120,hx+40,hy-150,hx+20,hy-100);x0.stroke();
  x0.fillStyle=rgba(pc(1),0.95);x0.shadowBlur=30;x0.shadowColor=pc(1);for(const[ex,ey]of[[hx-50,hy-20],[hx+50,hy-20]]){x0.beginPath();x0.ellipse(ex,ey,22,16,0,0,Math.PI*2);x0.fill();x0.fillStyle='rgba(0,0,0,0.9)';x0.beginPath();x0.arc(ex,ey,9,0,Math.PI*2);x0.fill();}
  x0.shadowBlur=0;x0.restore();
}
function drawMountOlympus(t){
  const w=W(),h=H(),cx=w/2;
  const sg=x0.createRadialGradient(cx,h*0.3,0,cx,h*0.5,h);const sc=h2r(pc(2));sg.addColorStop(0,`rgba(${sc.r},${sc.g},${sc.b},${0.2*(1+SM.beatPulse*0.3)})`);sg.addColorStop(0.5,THEME.bgColor);sg.addColorStop(1,'rgba(0,0,0,1)');x0.fillStyle=sg;x0.fillRect(0,0,w,h);
  if(SD.clouds)for(const cl of SD.clouds){cl.x+=cl.vx;if(cl.x<-cl.r*2)cl.x=w+cl.r;if(cl.x>w+cl.r*2)cl.x=-cl.r;const cg=x0.createRadialGradient(cl.x,cl.y,0,cl.x,cl.y,cl.r);cg.addColorStop(0,rgba(pc(cl.ci),0.25*(1+SM.beatPulse*0.2)));cg.addColorStop(1,'transparent');x0.fillStyle=cg;x0.fillRect(0,0,w,h);}
  if(SD.zeusFace&&SD.zeusFace.alpha>0.01){SD.zeusFace.alpha*=0.993;SD.zeusFace.scale=Math.min(1,SD.zeusFace.scale+0.02);x0.save();x0.globalAlpha=SD.zeusFace.alpha;x0.translate(cx,h*0.3);x0.scale(SD.zeusFace.scale,SD.zeusFace.scale);x0.shadowBlur=60;x0.shadowColor=pc(1);x0.fillStyle=rgba(pc(2),0.4);x0.beginPath();x0.ellipse(0,0,120,140,0,0,Math.PI*2);x0.fill();x0.strokeStyle=rgba(pc(3),0.6);x0.lineWidth=4;for(let b=0;b<8;b++){x0.beginPath();x0.moveTo((b-3.5)*25,60);x0.bezierCurveTo((b-3.5)*25+Math.sin(b)*15,100,(b-3.5)*22,140,(b-3.5)*20+Math.sin(b*2)*10,180);x0.stroke();}x0.fillStyle=rgba(pc(1),0.95);x0.shadowBlur=40;for(const[ex,ey]of[[-45,-20],[45,-20]]){x0.beginPath();x0.ellipse(ex,ey,20,15,0,0,Math.PI*2);x0.fill();}x0.shadowBlur=0;x0.restore();}
  x0.fillStyle=rgba(pc(3),0.1);for(let c=0;c<5;c++){x0.fillRect(w*(0.1+c*0.2)-15,h*0.4,30,h*0.6);}
  if(SD.boltsComing)for(let i=SD.boltsComing.length-1;i>=0;i--){const b=SD.boltsComing[i];b.x+=b.vx;b.y+=b.vy;b.size*=1.06;b.life-=0.03;if(b.life<=0||b.y>h){SD.boltsComing.splice(i,1);continue;}x0.save();x0.translate(b.x,b.y);x0.shadowBlur=20;x0.shadowColor=pc(b.ci);x0.fillStyle=rgba(pc(b.ci),b.life);x0.beginPath();x0.moveTo(0,-b.size);x0.lineTo(b.size*0.3,-b.size*0.1);x0.lineTo(b.size*0.1,-b.size*0.1);x0.lineTo(b.size*0.4,b.size);x0.lineTo(-b.size*0.1,b.size*0.1);x0.lineTo(0,b.size*0.1);x0.closePath();x0.fill();x0.shadowBlur=0;x0.restore();}
  SD.ltTimer=(SD.ltTimer||0)-16;if(SD.ltTimer<0&&SD.lightnings){SD.lightnings.push(mkLightning());SD.ltTimer=700+Math.random()*900;}
  if(SD.lightnings)for(let i=SD.lightnings.length-1;i>=0;i--){const lt=SD.lightnings[i];lt.life-=0.07;if(lt.life<=0){SD.lightnings.splice(i,1);continue;}x0.shadowBlur=25;x0.shadowColor=pc(lt.ci);for(const seg of lt.segs){x0.beginPath();x0.moveTo(seg.x1,seg.y1);x0.lineTo(seg.x2,seg.y2);x0.strokeStyle=rgba(pc(lt.ci),lt.life);x0.lineWidth=lt.life*3;x0.stroke();}x0.shadowBlur=0;}
}
function drawSuperMario(t){
  const w=W(),h=H();
  x0.fillStyle='#5C94FC';x0.fillRect(0,0,w,h);
  for(let c=0;c<4;c++){const cx2=((c*w/3+t*0.02)%w+w)%w,cy2=h*0.15+c*h*0.06;x0.fillStyle='rgba(255,255,255,0.85)';x0.beginPath();x0.arc(cx2,cy2,40,0,Math.PI*2);x0.arc(cx2+30,cy2-10,30,0,Math.PI*2);x0.arc(cx2+60,cy2,40,0,Math.PI*2);x0.fill();}
  SD.scrollX=(SD.scrollX||0)+THEME.sceneSpeed*(1+SM.energy*0.3)*(1+beatFX.speedBoost*0.5);
  x0.fillStyle='#50a000';x0.fillRect(0,h*0.78,w,h*0.06);x0.fillStyle='#804000';x0.fillRect(0,h*0.84,w,h*0.16);
  if(SD.pipes)for(const pipe of SD.pipes){const px=((pipe.x-SD.scrollX%w+w*2)%w);x0.fillStyle='rgba(0,160,0,0.9)';x0.fillRect(px-20,h*0.78-pipe.h,40,pipe.h);x0.fillRect(px-25,h*0.78-pipe.h,50,20);}
  if(SD.platforms)for(const p of SD.platforms){const px=((p.x-SD.scrollX*0.5+w*2)%w);x0.fillStyle=rgba(pc(0),0.8);x0.fillRect(px,p.y,p.w,16);}
  for(let q=0;q<4;q++){const qx=((q*w/3+w/6-SD.scrollX*0.7+w*2)%w),qy=h*0.5+Math.sin(q)*h*0.08;x0.fillStyle=rgba(pc(q%4),0.9*(1+SM.beatPulse*0.1));x0.fillRect(qx-15,qy-15,30,30);x0.fillStyle='rgba(0,0,0,0.7)';x0.font='bold 18px monospace';x0.textAlign='center';x0.fillText('?',qx,qy+7);x0.textAlign='left';}
  if(SD.coins)for(const c of SD.coins){c.ph+=0.08;const cx2=((c.x-SD.scrollX*0.6+w*2)%w);x0.save();x0.translate(cx2,c.y);x0.scale(Math.abs(Math.sin(c.ph)),1);x0.fillStyle=rgba(pc(1),0.9);x0.beginPath();x0.arc(0,0,10,0,Math.PI*2);x0.fill();x0.restore();}
  if(SD.goombas)for(const g of SD.goombas){g.x+=g.vx*(1+SM.energy*0.2);if(g.x<-30||g.x>w+30)g.vx*=-1;x0.fillStyle=rgba(pc(2),0.9);x0.beginPath();x0.arc(g.x,g.y,18,0,Math.PI*2);x0.fill();x0.fillStyle='rgba(0,0,0,0.8)';x0.beginPath();x0.arc(g.x-7,g.y-4,4,0,Math.PI*2);x0.arc(g.x+7,g.y-4,4,0,Math.PI*2);x0.fill();}
  const my=h*0.7;x0.fillStyle=rgba(pc(0),0.9);x0.fillRect(w*0.3-12,my-40,24,40);x0.beginPath();x0.arc(w*0.3,my-44,14,0,Math.PI*2);x0.fill();x0.fillRect(w*0.3-16,my-58,32,12);x0.fillRect(w*0.3-8,my-70,20,14);
}
function drawAtlantis(t){
  const w=W(),h=H();
  const wg=x0.createLinearGradient(0,0,0,h);const wc=h2r(pc(2));wg.addColorStop(0,`rgba(${wc.r},${wc.g},${wc.b},0.3)`);wg.addColorStop(0.5,THEME.bgColor);wg.addColorStop(1,'rgba(0,0,0,0.95)');x0.fillStyle=wg;x0.fillRect(0,0,w,h);
  if(SD.lightShafts)for(const ls of SD.lightShafts){ls.ph+=0.003;const lx=ls.x+Math.sin(ls.ph)*40;x0.save();x0.globalAlpha=0.06*(1+SM.beatPulse*0.3);const lg=x0.createLinearGradient(lx,0,lx+30,h);const lc=h2r(pc(1));lg.addColorStop(0,`rgba(${lc.r},${lc.g},${lc.b},1)`);lg.addColorStop(1,'transparent');x0.fillStyle=lg;x0.beginPath();x0.moveTo(lx,0);x0.lineTo(lx+60,0);x0.lineTo(lx+120,h);x0.lineTo(lx-60,h);x0.closePath();x0.fill();x0.restore();}
  if(SD.ruins)for(const r of SD.ruins){const rx=r.x*w,ry=h-r.h;x0.fillStyle=rgba(pc(r.ci),0.15);x0.fillRect(rx-r.w/2,ry,r.w,r.h);x0.strokeStyle=rgba(pc(r.ci),0.3);x0.lineWidth=1;x0.strokeRect(rx-r.w/2,ry,r.w,r.h);}
  if(SD.fish)for(const f of SD.fish){f.x+=f.vx*(1+SM.energy*0.2);f.y+=f.vy;if(f.x<-30)f.x=w+30;if(f.x>w+30)f.x=-30;if(f.y<0||f.y>h)f.vy*=-1;x0.save();x0.translate(f.x,f.y);x0.rotate(Math.atan2(f.vy,f.vx));x0.fillStyle=rgba(pc(f.ci),0.7);x0.beginPath();x0.moveTo(f.sz,0);x0.lineTo(-f.sz,f.sz*0.4);x0.lineTo(-f.sz,-f.sz*0.4);x0.closePath();x0.fill();x0.restore();}
  if(SD.bubbles)for(const b of SD.bubbles){b.y+=b.vy;b.ph+=0.05;if(b.y<-10){b.y=h+10;b.x=Math.random()*w;}x0.beginPath();x0.arc(b.x+Math.sin(b.ph)*3,b.y,b.r,0,Math.PI*2);x0.strokeStyle=rgba(pc(1),0.3);x0.lineWidth=1;x0.stroke();}
}
function drawCarnival(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  x0.fillStyle=rgba(pc(0),0.12);x0.beginPath();x0.moveTo(cx,h*0.05);x0.lineTo(w*0.05,h*0.5);x0.lineTo(w*0.95,h*0.5);x0.closePath();x0.fill();
  if(SD.tentLights)for(const tl of SD.tentLights){tl.ph+=0.04;const lx=cx+Math.cos(tl.angle)*w*0.4,ly=cy*0.8+Math.sin(tl.angle)*h*0.25,br=Math.sin(tl.ph)*0.5+0.5;x0.beginPath();x0.arc(lx,ly,4*(1+SM.beatPulse*0.5),0,Math.PI*2);x0.fillStyle=rgba(pc(tl.ci),0.6+br*0.4);x0.shadowBlur=10;x0.shadowColor=pc(tl.ci);x0.fill();x0.shadowBlur=0;}
  SD.ferrisRot=(SD.ferrisRot||0)+0.008+SM.energy*0.005+SM.beatPulse*0.02;
  const ferrisR=Math.min(w,h)*(0.28+SM.beatPulse*0.01); // BIGGER wheel
  const ferrisCX=cx,ferrisCY=h*0.42;
  x0.save();x0.translate(ferrisCX,ferrisCY);x0.rotate(SD.ferrisRot);x0.strokeStyle=rgba(pc(0),0.5);x0.lineWidth=4;x0.shadowBlur=10;x0.shadowColor=pc(0);x0.beginPath();x0.arc(0,0,ferrisR,0,Math.PI*2);x0.stroke();
  // Inner ring
  x0.beginPath();x0.arc(0,0,ferrisR*0.3,0,Math.PI*2);x0.strokeStyle=rgba(pc(1),0.4);x0.lineWidth=3;x0.stroke();
  for(let s=0;s<12;s++){const a=s/12*Math.PI*2;x0.beginPath();x0.moveTo(0,0);x0.lineTo(Math.cos(a)*ferrisR,Math.sin(a)*ferrisR);x0.strokeStyle=rgba(pc(s%4),0.3);x0.lineWidth=2;x0.stroke();}
  x0.shadowBlur=0;x0.restore();
  // Gondolas as centerpiece symbols — mini versions at each spoke tip
  if(THEME.centerpiece){
    x1.clearRect(0,0,w,h);
    for(let s=0;s<12;s++){
      const a=s/12*Math.PI*2+SD.ferrisRot;
      const gx=ferrisCX+Math.cos(a)*ferrisR,gy=ferrisCY+Math.sin(a)*ferrisR;
      x1.save();x1.translate(gx,gy);x1.rotate(-SD.ferrisRot+cpRot); // counter-rotate so gondola stays upright
      const gs=Math.min(w,h)*(0.022+SM.beatPulse*0.006);
      x1.globalAlpha=0.75+SM.beatPulse*0.15;x1.shadowBlur=gs*1.5;x1.shadowColor=pc(s%4);
      const gg2=x1.createRadialGradient(0,0,0,0,0,gs);gg2.addColorStop(0,rgba(pc(s%4),0.95));gg2.addColorStop(1,'transparent');x1.fillStyle=gg2;x1.beginPath();x1.arc(0,0,gs,0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();
    }
    cpRot+=0.015;
  }
  if(SD.confetti)for(const c of SD.confetti){c.x+=c.vx;c.y+=c.vy*(1+SM.energy*0.2);c.rot+=c.rotS;if(c.y>h+10){c.y=-10;c.x=Math.random()*w;}x0.save();x0.translate(c.x,c.y);x0.rotate(c.rot);x0.fillStyle=rgba(pc(c.ci),0.7);x0.fillRect(-c.sz/2,-c.sz*0.3,c.sz,c.sz*0.6);x0.restore();}
}
function drawEgyptianTomb(t){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  x0.fillStyle=THEME.bgColor;x0.fillRect(0,0,w,h);
  SD.tunnelZ=(SD.tunnelZ||0)+THEME.sceneSpeed*0.01*(1+SM.energy*0.4)*progMult;
  for(let d=8;d>0;d--){const z=((d/8+SD.tunnelZ)%1),cw=lerp(w*0.5,0,z),ch2=lerp(h*0.5,0,z),alpha=(0.1+z*0.5)*THEME.sceneIntensity;x0.strokeStyle=rgba(pc(d%4),alpha);x0.lineWidth=1+z*2;x0.shadowBlur=z>0.6?10:0;x0.shadowColor=pc(d%4);x0.strokeRect(cx-cw,cy-ch2,cw*2,ch2*2);x0.shadowBlur=0;}
  const hChars=['𓀀','𓂀','𓃭','𓄿','𓇋','𓈖','𓊖','𓌃','𓎛','𓏏','𓐍','𓇼'];
  if(SD.hieroglyphs)for(const hg of SD.hieroglyphs){x0.font='18px serif';x0.fillStyle=rgba(pc(hg.ci),hg.alpha*(0.8+SM.beatPulse*0.2));x0.fillText(hChars[hg.char%hChars.length],hg.x,hg.y);}
  if(SD.torches)for(const tr of SD.torches){tr.ph+=0.08;const fx=Math.sin(tr.ph)*4,tx=tr.x*w;x0.fillStyle='rgba(100,60,20,0.8)';x0.fillRect(tx-4,h*0.55,8,40);const fg=x0.createRadialGradient(tx+fx,h*0.53,0,tx+fx,h*0.53,28);fg.addColorStop(0,'rgba(255,200,50,0.9)');fg.addColorStop(0.4,rgba(pc(0),0.6));fg.addColorStop(1,'transparent');x0.fillStyle=fg;x0.beginPath();x0.arc(tx+fx,h*0.53,24,0,Math.PI*2);x0.fill();}
  if(SD.traps)for(let i=SD.traps.length-1;i>=0;i--){const tr=SD.traps[i];tr.y+=tr.vy;tr.life-=0.02;if(tr.y>h||tr.life<=0){SD.traps.splice(i,1);continue;}x0.fillStyle=rgba(pc(tr.ci),tr.life*0.8);x0.beginPath();x0.moveTo(tr.x,tr.y);x0.lineTo(tr.x-10,tr.y-30);x0.lineTo(tr.x+10,tr.y-30);x0.closePath();x0.fill();}
  // Centerpiece stamped as repeating symbol on corridor walls
  if(THEME.centerpiece){
    x1.clearRect(0,0,w,h);
    const stampSz=Math.min(w,h)*0.06*(0.7+SM.beatPulse*0.2);
    const stampAlpha=(0.06+songProg*0.1+SM.beatPulse*0.04);
    // Stamp along both walls as you fly through corridor
    for(let row=0;row<4;row++){
      const depth=row/4,yw=h*0.5*(1-depth*0.7),xOff=w*depth*0.4;
      for(let side=0;side<2;side++){
        const sx=side===0?xOff+w*0.04:w-xOff-w*0.04;
        const sy=h*0.5+Math.sin(row+SD.tunnelZ*3)*h*0.03;
        x1.save();x1.translate(sx,sy);x1.rotate(cpRot+(row+side)*0.5);x1.globalAlpha=stampAlpha*(1-depth*0.3);
        x1.shadowBlur=10;x1.shadowColor=pc(row%4);
        const sg2=x1.createRadialGradient(0,0,0,0,0,stampSz*(1-depth*0.4));sg2.addColorStop(0,rgba(pc(row%4),0.8));sg2.addColorStop(1,'transparent');x1.fillStyle=sg2;x1.beginPath();x1.arc(0,0,stampSz*(1-depth*0.4),0,Math.PI*2);x1.fill();x1.shadowBlur=0;x1.restore();
      }
    }
    cpRot+=0.003;
  }
}

// ═══ CENTERPIECE ═══
// Bounce state
let cpBounceX=0,cpBounceY=0,cpBounceVX=0.7,cpBounceVY=0.5;
let cpDriftX=0,cpDriftY=0;

function drawCenterpiece(ctx,t){
  if(!THEME.centerpiece||THEME.centerpieceScale===0)return;
  const w=W(),h=H();
  // Base position from AI (defaults to center)
  const baseCX=w*(THEME.centerpieceX||0.5);
  const baseCY=h*(THEME.centerpieceY||0.5);
  const s=Math.min(w,h)*THEME.centerpieceScale*0.42;
  cpPh+=0.012;
  let posX=baseCX,posY=baseCY,alpha=1;
  switch(THEME.centerpieceBehavior){
    case 'spin_fast':cpRot+=0.07*(1+SM.energy);break;
    case 'pulse_beat':cpRot+=0.005;break;
    case 'orbit_slow':cpOrbit+=0.007;break;
    case 'strobe':cpRot+=0.04;break;
    case 'bounce':
      cpRot+=0.02;
      cpBounceX+=cpBounceVX*(1+SM.energy*0.3);
      cpBounceY+=cpBounceVY*(1+SM.energy*0.3);
      if(cpBounceX>w*0.4||cpBounceX<-w*0.4)cpBounceVX*=-1;
      if(cpBounceY>h*0.35||cpBounceY<-h*0.35)cpBounceVY*=-1;
      posX=baseCX+cpBounceX;posY=baseCY+cpBounceY;
      break;
    case 'drift':
      cpRot+=0.008;
      cpDriftX=Math.sin(t*0.0004)*w*0.2;
      cpDriftY=Math.cos(t*0.0003)*h*0.15;
      posX=baseCX+cpDriftX;posY=baseCY+cpDriftY;
      break;
    case 'watermark':
      cpRot+=0.002;
      alpha=0.07+Math.sin(cpPh*0.3)*0.03;
      break;
    default:cpRot+=0.01*(1+SM.energy*0.2);
  }
  const pulseMult=THEME.centerpieceBehavior==='pulse_beat'?1+SM.beatPulse*0.3:THEME.centerpieceBehavior==='breathe'?1+Math.sin(cpPh*0.5)*0.08:THEME.centerpieceBehavior==='strobe'?SM.beatPulse>0.5?1:0:1;
  const orbX=THEME.centerpieceBehavior==='orbit_slow'?Math.cos(cpOrbit)*w*0.12:0;
  const orbY=THEME.centerpieceBehavior==='orbit_slow'?Math.sin(cpOrbit)*h*0.07:THEME.centerpieceBehavior==='rise_set'?Math.sin(t*0.0001)*h*0.12:0;
  const sz=s*pulseMult;if(sz<2)return;
  ctx.save();ctx.globalAlpha=alpha;ctx.translate(posX+orbX,posY+orbY);ctx.rotate(cpRot);
  const cp=THEME.centerpiece;
  if(cp==='sun'){
    for(let r=0;r<16;r++){const a=r/16*Math.PI*2,rL=sz*(1.3+Math.sin(cpPh+r)*0.15+SM.beatPulse*0.25);ctx.save();ctx.rotate(a);const rg=ctx.createLinearGradient(0,sz*0.7,0,rL);rg.addColorStop(0,rgba(pc(0),0.7));rg.addColorStop(1,'transparent');ctx.fillStyle=rg;ctx.fillRect(-sz*0.04,sz*0.7,sz*0.08,rL-sz*0.7);ctx.restore();}
    const og=ctx.createRadialGradient(0,0,sz*0.2,0,0,sz*1.6);og.addColorStop(0,rgba(pc(1),0.12));og.addColorStop(1,'transparent');ctx.fillStyle=og;ctx.beginPath();ctx.arc(0,0,sz*1.6,0,Math.PI*2);ctx.fill();
    const sg=ctx.createRadialGradient(-sz*0.2,-sz*0.2,0,0,0,sz);sg.addColorStop(0,'rgba(255,255,200,1)');sg.addColorStop(0.3,rgba(pc(1),0.9));sg.addColorStop(1,rgba(pc(0),0.5));ctx.fillStyle=sg;ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.shadowBlur=sz*0.7;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;
  }else if(cp==='moon'){
    const mg=ctx.createRadialGradient(-sz*0.15,-sz*0.15,0,0,0,sz);mg.addColorStop(0,'rgba(230,230,255,0.95)');mg.addColorStop(0.7,rgba(pc(2),0.7));mg.addColorStop(1,rgba(pc(1),0.2));ctx.fillStyle=mg;ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.shadowBlur=sz*0.35;ctx.shadowColor=pc(2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle=rgba(THEME.bgColor,0.88);ctx.beginPath();ctx.arc(sz*0.28,0,sz*0.83,0,Math.PI*2);ctx.fill();
  }else if(cp==='planet'){
    const pg=ctx.createRadialGradient(-sz*0.3,-sz*0.3,0,0,0,sz);pg.addColorStop(0,rgba(pc(2),1));pg.addColorStop(0.6,rgba(pc(0),0.8));pg.addColorStop(1,rgba(pc(1),0.4));ctx.fillStyle=pg;ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.shadowBlur=sz*0.25;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;ctx.save();ctx.scale(1,0.28);for(let ri=0;ri<3;ri++){ctx.beginPath();ctx.arc(0,0,sz*(1.4+ri*0.22),0,Math.PI*2);ctx.strokeStyle=rgba(pc((ri+2)%4),0.25-ri*0.07);ctx.lineWidth=7+ri*3;ctx.stroke();}ctx.restore();
  }else if(cp==='disco_ball'){
    const rows=14,cols=18;for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){const lat=(r/rows-0.5)*Math.PI,lon=c/cols*Math.PI*2+cpRot*3;const tx=Math.cos(lat)*Math.cos(lon)*sz,ty=Math.sin(lat)*sz,tz=Math.cos(lat)*Math.sin(lon);if(tz<0.1)continue;const tsz=4+tz*3;ctx.fillStyle=rgba(pc((r+c)%4),(0.3+Math.abs(Math.sin(lon+cpRot*2+lat))*0.7)*0.9*(0.5+tz*0.5));ctx.fillRect(tx-tsz/2,ty-tsz/2,tsz,tsz);}
  }else if(cp==='fireball'){
    for(let layer=4;layer>0;layer--){const fl=1+Math.sin(cpPh*3+layer)*0.15+SM.beatPulse*0.2;const fg=ctx.createRadialGradient(0,sz*0.04*layer,0,0,0,sz*fl*(0.6+layer*0.12));fg.addColorStop(0,'rgba(255,220,80,0.95)');fg.addColorStop(0.3,rgba(pc(1),0.7-layer*0.1));fg.addColorStop(1,'transparent');ctx.fillStyle=fg;ctx.beginPath();ctx.arc(0,0,sz*fl*(0.5+layer*0.13),0,Math.PI*2);ctx.fill();}
  }else if(cp==='skull'){
    ctx.fillStyle=rgba(pc(0),0.85);ctx.beginPath();ctx.ellipse(0,-sz*0.15,sz*0.55,sz*0.6,0,0,Math.PI*2);ctx.shadowBlur=25;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle=rgba(THEME.bgColor,0.9);for(const[ex,ey]of[[-sz*0.22,-sz*0.2],[sz*0.22,-sz*0.2]]){ctx.beginPath();ctx.ellipse(ex,ey,sz*0.16,sz*0.18,0,0,Math.PI*2);ctx.fill();}ctx.fillStyle=rgba(pc(0),0.7);ctx.fillRect(-sz*0.4,sz*0.28,sz*0.8,sz*0.08);
  }else if(cp==='wormhole'){
    for(let ring=10;ring>0;ring--){ctx.beginPath();ctx.arc(0,0,sz*(ring/10),0,Math.PI*2);ctx.strokeStyle=rgba(pc(ring%4),0.4*(ring/10)+SM.beatPulse*0.15);ctx.lineWidth=sz*0.05;ctx.stroke();}const pvg=ctx.createRadialGradient(0,0,0,0,0,sz*0.45);pvg.addColorStop(0,'rgba(0,0,0,1)');pvg.addColorStop(0.8,rgba(pc(0),0.3));pvg.addColorStop(1,'transparent');ctx.fillStyle=pvg;ctx.beginPath();ctx.arc(0,0,sz*0.45,0,Math.PI*2);ctx.fill();
  }else if(cp==='chandelier'){
    ctx.strokeStyle=rgba(pc(0),0.8);ctx.lineWidth=3;ctx.shadowBlur=15;ctx.shadowColor=pc(0);ctx.beginPath();ctx.moveTo(0,-sz*0.5);ctx.lineTo(0,sz*0.8);ctx.stroke();for(let arm=0;arm<4;arm++){const a=arm/4*Math.PI*2+cpRot*0.5,ax=Math.cos(a)*sz*0.7,ay=Math.sin(a)*sz*0.2-sz*0.1;ctx.beginPath();ctx.moveTo(0,-sz*0.1);ctx.lineTo(ax,ay);ctx.stroke();ctx.beginPath();ctx.arc(ax,ay,sz*0.06,0,Math.PI*2);ctx.fillStyle=rgba(pc((arm+1)%4),0.9);ctx.fill();}ctx.shadowBlur=0;
  }else if(cp==='crown'){
    ctx.fillStyle=rgba(pc(1),0.85);ctx.shadowBlur=20;ctx.shadowColor=pc(1);ctx.fillRect(-sz*0.7,0,sz*1.4,sz*0.35);for(let p=0;p<5;p++){const px2=-sz*0.7+p*sz*0.35;ctx.beginPath();ctx.moveTo(px2,0);ctx.lineTo(px2+sz*0.175,-sz*(0.4+Math.sin(p)*0.15));ctx.lineTo(px2+sz*0.35,0);ctx.closePath();ctx.fill();}ctx.shadowBlur=0;for(let j=0;j<5;j++){ctx.fillStyle=rgba(pc(j%4),0.95);ctx.beginPath();ctx.arc(-sz*0.525+j*sz*0.2625,sz*0.175,sz*0.08*(1+SM.beatPulse*0.3),0,Math.PI*2);ctx.fill();}
  }else if(cp==='mandala'){
    for(let layer=0;layer<6;layer++){const r=sz*(0.15+layer*0.14);const petals=6+layer*2;for(let p=0;p<petals;p++){const a=p/petals*Math.PI*2+cpRot*(1-layer*0.1);ctx.save();ctx.rotate(a);ctx.fillStyle=rgba(pc((layer+p)%4),(0.4-layer*0.05)*THEME.sceneIntensity);ctx.beginPath();ctx.ellipse(r,0,r*0.35,r*0.12,0,0,Math.PI*2);ctx.fill();ctx.restore();}}ctx.fillStyle=rgba(pc(0),0.8);ctx.shadowBlur=15;ctx.shadowColor=pc(0);ctx.beginPath();ctx.arc(0,0,sz*0.1,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  }else if(cp==='dna_helix'){
    const segs=20;for(let strand=0;strand<2;strand++)for(let i=0;i<segs;i++){const y=i/segs*sz*2-sz,x=Math.cos(i/segs*Math.PI*4+cpRot+(strand/2)*Math.PI)*sz*0.4;const x2=Math.cos((i+1)/segs*Math.PI*4+cpRot+(strand/2)*Math.PI)*sz*0.4;const y2=(i+1)/segs*sz*2-sz;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x2,y2);ctx.strokeStyle=rgba(pc((strand*2+i)%4),0.8);ctx.lineWidth=sz*0.04;ctx.shadowBlur=6;ctx.shadowColor=pc(strand%4);ctx.stroke();ctx.shadowBlur=0;}for(let i=0;i<segs;i++){const y=i/segs*sz*2-sz;const x1=Math.cos(i/segs*Math.PI*4+cpRot)*sz*0.4,x2=Math.cos(i/segs*Math.PI*4+cpRot+Math.PI)*sz*0.4;ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.strokeStyle=rgba(pc(i%4),0.3);ctx.lineWidth=sz*0.02;ctx.stroke();}
  }else if(cp==='tesseract'){
    const draw3DBox=(scale,alpha,ci)=>{const pts=[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]].map(([px,py,pz])=>{const rx=px*Math.cos(cpRot)-pz*Math.sin(cpRot),rz=px*Math.sin(cpRot)+pz*Math.cos(cpRot);const ry=py*Math.cos(cpRot*0.7)-rz*Math.sin(cpRot*0.7),rz2=py*Math.sin(cpRot*0.7)+rz*Math.cos(cpRot*0.7);return{x:rx*sz*scale/(rz2+3)*3,y:ry*sz*scale/(rz2+3)*3};});[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]].forEach(([a,b])=>{ctx.beginPath();ctx.moveTo(pts[a].x,pts[a].y);ctx.lineTo(pts[b].x,pts[b].y);ctx.strokeStyle=rgba(pc(ci),alpha);ctx.lineWidth=sz*0.025;ctx.stroke();});};ctx.shadowBlur=10;ctx.shadowColor=pc(0);draw3DBox(0.4,0.9,0);draw3DBox(0.8,0.5,1);draw3DBox(1.2,0.3,2);ctx.shadowBlur=0;
  }else if(cp==='ankh'){
    ctx.strokeStyle=rgba(pc(0),0.9);ctx.lineWidth=sz*0.1;ctx.shadowBlur=20;ctx.shadowColor=pc(0);ctx.lineCap='round';ctx.beginPath();ctx.moveTo(0,-sz*0.2);ctx.lineTo(0,sz);ctx.stroke();ctx.beginPath();ctx.moveTo(-sz*0.5,sz*0.15);ctx.lineTo(sz*0.5,sz*0.15);ctx.stroke();ctx.beginPath();ctx.ellipse(0,-sz*0.55,sz*0.35,sz*0.42,0,0,Math.PI*2);ctx.strokeStyle=rgba(pc(0),0.9);ctx.stroke();ctx.lineCap='butt';ctx.shadowBlur=0;
  }else if(cp==='dragon_head'){
    ctx.fillStyle=rgba(pc(0),0.8);ctx.beginPath();ctx.ellipse(0,0,sz*1.0,sz*0.6,0,0,Math.PI*2);ctx.shadowBlur=30;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;ctx.beginPath();ctx.moveTo(sz*0.55,-sz*0.1);ctx.lineTo(sz*1.4,-sz*0.05);ctx.lineTo(sz*0.55,sz*0.15);ctx.closePath();ctx.fill();ctx.fillStyle=rgba(pc(1),0.95);ctx.shadowBlur=20;ctx.shadowColor=pc(1);for(const[ex,ey]of[[sz*0.2,-sz*0.2],[-sz*0.1,-sz*0.2]]){ctx.beginPath();ctx.ellipse(ex,ey,sz*0.15,sz*0.11,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(0,0,0,0.9)';ctx.beginPath();ctx.arc(ex,ey,sz*0.06,0,Math.PI*2);ctx.fill();}ctx.shadowBlur=0;
  }else if(cp==='sugar_skull'){
    ctx.fillStyle='rgba(255,250,245,0.9)';ctx.beginPath();ctx.ellipse(0,-sz*0.1,sz*0.65,sz*0.72,0,0,Math.PI*2);ctx.shadowBlur=20;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;for(const[ex,ey]of[[-sz*0.27,-sz*0.2],[sz*0.27,-sz*0.2]]){for(let fp=0;fp<6;fp++){const fa=fp/6*Math.PI*2;ctx.fillStyle=rgba(pc(fp%4),0.8);ctx.beginPath();ctx.arc(ex+Math.cos(fa)*sz*0.2,ey+Math.sin(fa)*sz*0.15,sz*0.06,0,Math.PI*2);ctx.fill();}ctx.fillStyle='rgba(0,0,0,0.8)';ctx.beginPath();ctx.ellipse(ex,ey,sz*0.14,sz*0.16,0,0,Math.PI*2);ctx.fill();}for(let t2=0;t2<5;t2++)ctx.fillRect(-sz*0.35+t2*sz*0.17,sz*0.28,sz*0.12,sz*0.18);
  }else if(cp==='supernova'){
    for(let r=0;r<8;r++){const rr=sz*(0.4+r*0.15)+SM.beatPulse*sz*0.2;const rg=ctx.createRadialGradient(0,0,rr*0.7,0,0,rr);rg.addColorStop(0,rgba(pc(r%4),0.4*(1-r/8)));rg.addColorStop(1,'transparent');ctx.fillStyle=rg;ctx.beginPath();ctx.arc(0,0,rr,0,Math.PI*2);ctx.fill();}for(let ray=0;ray<16;ray++){const a=ray/16*Math.PI*2+cpRot*0.5;const rl=sz*(1+Math.sin(cpPh+ray)*0.3+SM.beatPulse*0.4);ctx.beginPath();ctx.moveTo(Math.cos(a)*sz*0.3,Math.sin(a)*sz*0.3);ctx.lineTo(Math.cos(a)*rl,Math.sin(a)*rl);ctx.strokeStyle=rgba(pc(ray%4),0.5);ctx.lineWidth=2;ctx.stroke();}ctx.beginPath();ctx.arc(0,0,sz*0.3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,220,0.95)';ctx.shadowBlur=sz*0.4;ctx.shadowColor='rgba(255,255,200,1)';ctx.fill();ctx.shadowBlur=0;
  }else if(cp==='flaming_skull'){
    ctx.fillStyle=rgba(pc(0),0.85);ctx.beginPath();ctx.ellipse(0,-sz*0.1,sz*0.55,sz*0.6,0,0,Math.PI*2);ctx.shadowBlur=30;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle=rgba(THEME.bgColor,0.9);for(const[ex,ey]of[[-sz*0.22,-sz*0.2],[sz*0.22,-sz*0.2]]){ctx.beginPath();ctx.ellipse(ex,ey,sz*0.16,sz*0.18,0,0,Math.PI*2);ctx.fill();}for(let f=0;f<8;f++){const fa=f/8*Math.PI-Math.PI/8,fl=sz*(0.5+Math.sin(cpPh*4+f)*0.25),fx=Math.cos(fa)*sz*0.4,fy=-sz*0.7;const fg=ctx.createRadialGradient(fx,fy,0,fx,fy,fl);fg.addColorStop(0,'rgba(255,220,50,0.9)');fg.addColorStop(0.4,rgba(pc(0),0.6));fg.addColorStop(1,'transparent');ctx.fillStyle=fg;ctx.beginPath();ctx.arc(fx,fy-fl*0.3,fl*0.6,0,Math.PI*2);ctx.fill();}
  }else if(cp==='hourglass'){
    ctx.fillStyle=rgba(pc(0),0.3);ctx.strokeStyle=rgba(pc(0),0.8);ctx.lineWidth=2;ctx.shadowBlur=15;ctx.shadowColor=pc(0);ctx.beginPath();ctx.moveTo(-sz*0.5,-sz);ctx.lineTo(sz*0.5,-sz);ctx.lineTo(0,0);ctx.closePath();ctx.fill();ctx.stroke();ctx.beginPath();ctx.moveTo(-sz*0.5,sz);ctx.lineTo(sz*0.5,sz);ctx.lineTo(0,0);ctx.closePath();ctx.fill();ctx.stroke();ctx.shadowBlur=0;ctx.fillStyle=rgba(pc(1),0.8);ctx.fillRect(-sz*0.35*(1-songProg),-sz*(1-songProg*0.9),sz*0.7*(1-songProg),sz*(1-songProg*0.9));ctx.fillStyle=rgba(pc(2),0.7);ctx.fillRect(-sz*0.35,0,sz*0.7,sz*songProg*0.9);
  }else if(cp==='clock_face'){
    ctx.fillStyle='rgba(240,235,220,0.9)';ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.shadowBlur=sz*0.2;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;ctx.strokeStyle=rgba(pc(0),0.7);ctx.lineWidth=sz*0.04;ctx.stroke();for(let hr=0;hr<12;hr++){const ha=hr/12*Math.PI*2-Math.PI/2;ctx.beginPath();ctx.moveTo(Math.cos(ha)*sz*0.82,Math.sin(ha)*sz*0.82);ctx.lineTo(Math.cos(ha)*sz*0.92,Math.sin(ha)*sz*0.92);ctx.strokeStyle=rgba(pc(0),0.8);ctx.lineWidth=hr%3===0?sz*0.05:sz*0.025;ctx.stroke();}const ha=cpPh*0.1-Math.PI/2,ma=cpPh-Math.PI/2,sa=cpPh*10-Math.PI/2;ctx.strokeStyle=rgba(pc(0),0.9);ctx.lineWidth=sz*0.06;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(ha)*sz*0.55,Math.sin(ha)*sz*0.55);ctx.stroke();ctx.lineWidth=sz*0.04;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(ma)*sz*0.75,Math.sin(ma)*sz*0.75);ctx.stroke();ctx.strokeStyle=rgba(pc(2),0.9);ctx.lineWidth=sz*0.02;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(sa)*sz*0.85,Math.sin(sa)*sz*0.85);ctx.stroke();ctx.lineCap='butt';ctx.fillStyle=rgba(pc(0),1);ctx.beginPath();ctx.arc(0,0,sz*0.04,0,Math.PI*2);ctx.fill();
  }else{
    const dg=ctx.createRadialGradient(-sz*0.3,-sz*0.3,0,0,0,sz);dg.addColorStop(0,'rgba(255,255,255,0.6)');dg.addColorStop(0.4,rgba(pc(0),0.7));dg.addColorStop(1,rgba(pc(1),0.1));ctx.fillStyle=dg;ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.shadowBlur=sz*0.4;ctx.shadowColor=pc(0);ctx.fill();ctx.shadowBlur=0;
  }
  ctx.restore();
}

// ═══ BEAT FX RENDER ═══
function drawBeatFX(){
  const w=W(),h=H(),cx=w/2,cy=h/2;
  if(beatFX.shockwaveA>0.01){beatFX.shockwaveR+=12*(1+SM.energy);beatFX.shockwaveA*=0.88;x2.beginPath();x2.arc(cx,cy,beatFX.shockwaveR,0,Math.PI*2);x2.strokeStyle=rgba(pc(0),beatFX.shockwaveA);x2.lineWidth=3+beatFX.shockwaveA*5;x2.stroke();if(beatFX.shockwaveR>Math.sqrt(cx*cx+cy*cy)+100)beatFX.shockwaveA=0;}
  if(beatFX.crackLines.length>0){for(let i=beatFX.crackLines.length-1;i>=0;i--){const cl=beatFX.crackLines[i];cl.life-=0.05;if(cl.life<=0){beatFX.crackLines.splice(i,1);continue;}x2.shadowBlur=15;x2.shadowColor=pc(cl.ci);let prev={x:cx,y:cy};for(const seg of cl.segs){x2.beginPath();x2.moveTo(prev.x,prev.y);x2.lineTo(seg.x,seg.y);x2.strokeStyle=rgba(pc(cl.ci),cl.life*0.9);x2.lineWidth=cl.life*3;x2.stroke();prev=seg;}x2.shadowBlur=0;}}
  if(beatFX.invertA>0.01){x2.fillStyle=rgba(pc(0),beatFX.invertA*0.4);x2.fillRect(0,0,w,h);beatFX.invertA*=0.82;}
  if(beatFX.slamS>1.001){beatFX.slamS+=(1-beatFX.slamS)*0.15;}
  if(beatFX.gravityWave>0.01){x2.fillStyle=rgba(pc(2),beatFX.gravityWave*0.08);x2.fillRect(0,0,w,h);beatFX.gravityWave*=0.9;}
  beatFX.speedBoost*=0.88;
}

// ═══ RENDER LOOP ═══
function render(t){
  requestAnimationFrame(render);
  if(!token)return;
  const w=W(),h=H();
  SM.energy+=(MS.energy-SM.energy)*0.05;
  SM.beatPulse*=0.87;
  if(t-MS.lastBeat>MS.beatInterval){MS.lastBeat=t;triggerBeat();}
  if(MS.duration>0){songProg=Math.min(1,(Date.now()-MS.analysisStart)/MS.duration);progMult=0.55+songProg*0.7;}
  // Progress bar
  document.getElementById('pgBar').style.width=(songProg*100)+'%';
  // Cursor
  const tc=h2r(pc(Math.floor(t/3000)%4));document.getElementById('cur').style.background=`rgb(${tc.r},${tc.g},${tc.b})`;
  // Scene layer
  switch(THEME.scene){
    case 'WARP_SPEED':drawWarpSpeed(t);break;case 'LAVA_WORLD':drawLavaWorld(t);break;
    case 'CYBER_GRID':drawCyberGrid(t);break;case 'DEEP_SEA':drawDeepSea(t);break;
    case 'STORM_CHASER':drawStormChaser(t);break;case 'JUNGLE_RAVE':drawJungleRave(t);break;
    case 'DISCO_DIMENSION':drawDiscoDimension(t);break;case 'ACID_TRIP':drawAcidTrip(t);break;
    case 'SPACE_STATION':drawSpaceStation(t);break;case 'NEON_CATHEDRAL':drawNeonCathedral(t);break;
    case 'CLASSIC_ARCADE':drawClassicArcade(t);break;case 'ELECTRIC_FOREST':drawElectricForest(t);break;
    case 'OMNIA_NIGHTCLUB':drawOmniaNightclub(t);break;case 'PIRATE_SHIP':drawPirateShip(t);break;
    case 'JUNKYARD':drawJunkyard(t);break;case 'SUPERHERO':drawSuperhero(t);break;
    case 'DAY_OF_DEAD':drawDayOfDead(t);break;case 'CHINESE_DRAGON':drawChineseDragon(t);break;
    case 'MOUNT_OLYMPUS':drawMountOlympus(t);break;case 'SUPER_MARIO':drawSuperMario(t);break;
    case 'ATLANTIS':drawAtlantis(t);break;case 'CARNIVAL':drawCarnival(t);break;
    case 'EGYPTIAN_TOMB':drawEgyptianTomb(t);break;default:drawWarpSpeed(t);
  }
  // Centerpiece layer
  x1.clearRect(0,0,w,h);
  if(THEME.centerpiece&&THEME.centerpieceScale>0){
    x1.save();
    if(beatFX.slamS>1.002){x1.translate(w/2,h/2);x1.scale(beatFX.slamS,beatFX.slamS);x1.translate(-w/2,-h/2);}
    drawCenterpiece(x1,t);
    x1.restore();
  }
  // Beat FX layer
  x2.clearRect(0,0,w,h);
  drawBeatFX();
  // Vignette
  x3.clearRect(0,0,w,h);
  const vg=x3.createRadialGradient(w/2,h/2,h*0.2,w/2,h/2,h*0.85);
  vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,0.55)');
  x3.fillStyle=vg;x3.fillRect(0,0,w,h);
}
requestAnimationFrame(render);

// ═══ TRANSITION ═══
async function transition(name,artist,theme){
  if(inTrans)return;inTrans=true;
  const wash=document.getElementById('wash'),splash=document.getElementById('splash');
  const c=h2r(theme.palette[0]);
  wash.style.background=`radial-gradient(ellipse at 50% 40%,rgba(${c.r},${c.g},${c.b},0.92) 0%,rgba(0,0,0,0.97) 70%)`;
  wash.style.transition='opacity 1.1s ease';wash.style.opacity='1';
  await delay(1200);
  Object.assign(THEME,theme);
  MS.energy=theme.energy||0.5;songProg=0;progMult=0.55;
  initScene();
  document.getElementById('cur').style.background=theme.palette[0];
  document.getElementById('trackName').style.color=theme.palette[0];
  document.getElementById('sceneTag').style.color=theme.palette[2]||theme.palette[0];
  document.getElementById('pgBar').style.background=`linear-gradient(90deg,${theme.palette[1]||theme.palette[0]},${theme.palette[0]})`;
  document.getElementById('pgBar').style.boxShadow=`0 0 8px ${theme.palette[0]}`;
  document.getElementById('sceneTag').textContent=(theme.scene||'SCENE').replace(/_/g,' ')+' — '+(theme.label||'');
  document.getElementById('splashScene').textContent='— '+(theme.scene||'').replace(/_/g,' ')+' —';
  document.getElementById('splashTrack').textContent=name;
  document.getElementById('splashTrack').style.color=theme.palette[0];
  document.getElementById('splashArtist').textContent=artist;
  document.getElementById('splashDesc').textContent=theme.splashDesc||'';
  splash.classList.add('show');
  wash.style.transition='opacity 1.0s ease';wash.style.opacity='0';
  await delay(2200);
  splash.style.transition='opacity 0.7s ease';splash.style.opacity='0';
  await delay(800);
  splash.classList.remove('show');splash.style.opacity='';splash.style.transition='';
  inTrans=false;
}

// ═══ AI THEME LOADER ═══
const ARTIST_CTX={'marshmello':'Marshmello white marshmallow helmet X eyes. EDM festival.','daft punk':'Daft Punk robot helmets. French house. Disco. Tron neon.','deadmau5':'Mouse head helmet. Progressive house. Dark neon.','pink floyd':'Prism rainbow. Flying pigs. Psychedelic prog rock.','the weeknd':'Neon 80s. Red black. Blinding Lights city highways.','david bowie':'Ziggy Stardust lightning bolt. Glam. Cosmic.','queen':'Stadium rock. Operatic grandeur. Freddie Mercury.','nirvana':'Grunge. Dark raw distorted energy.','eminem':'Detroit. 8 Mile. Raw urban intense.','kendrick lamar':'Compton. DNA. DAMN imagery.','taylor swift':'Sparkles. Eras. Stadium spectacle.','billie eilish':'Dark green black. Spider webs. Haunted.','coldplay':'Colorful confetti. Neon wristbands. Cosmos.','radiohead':'Dystopian glitch. OK Computer robot anxiety.','metallica':'Thrash metal. Lightning bolt. Fire skulls.','skrillex':'Heavy dubstep. Glitch alien.','flume':'Organic futurism. Bioluminescent crystals.'};
function getArtistCtx(name){const k=name.toLowerCase();for(const[n,v]of Object.entries(ARTIST_CTX))if(k.includes(n))return v;return null;}
function extractKW(title){const stop=new Set(['a','an','the','in','of','to','and','or','i','my','me','you','is','it','by','on','for','with','as','be','was']);return title.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stop.has(w)).slice(0,6);}

async function loadTheme(tid,name,artist,artistIds,isExplicit,durationMs){
  if(aiCache[tid]){applyTheme(name,artist,aiCache[tid]);return;}
  let genres=[];
  try{const a=await spGet(`artists?ids=${artistIds.slice(0,3).join(',')}`);if(a?.artists)genres=a.artists.flatMap(x=>x.genres||[]).slice(0,8);}catch{}
  const streakDesc=sessionStreak<3?'early session':sessionStreak<6?'warmed up — go wilder':sessionStreak<10?'deep session — darker and more extreme':sessionStreak<15?'long session — full maximalist chaos':'marathon — most extreme worlds, nothing held back';
  const shortlist=getSceneShortlist();
  try{
    const r=await fetch('/api/theme',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({trackName:name,artistName:artist,genres,titleKeywords:extractKW(name),artistContext:getArtistCtx(artist)||`Genres: ${genres.join(', ')}`,sceneShortlist:shortlist,forbiddenCenterpieces:getForbidCPs(),sessionStreak,streakDesc,isExplicit:!!isExplicit,songDurationSecs:Math.round((durationMs||180000)/1000)})});
    if(!r.ok)throw new Error('HTTP '+r.status);
    const raw=await r.json();if(raw.error)throw new Error(raw.error);
    const VALID_BEH=['rotate','spin_fast','pulse_beat','breathe','orbit_slow','rise_set','fixed','strobe','bounce','drift','watermark'];
    const VALID_BEATS=['speed_burst','shockwave','color_invert','world_crack','bass_slam','strobe_cut','creature_surge','cannon_fire','lightning_strike','gravity_wave','petal_burst','pixel_explode','skull_surge','coin_shower','tentacle_surge'];
    const scene=enforceScene((raw.scene||shortlist[0]||'WARP_SPEED').toUpperCase().replace(/ /g,'_'),shortlist);
    const cp=enforceCP(raw.centerpiece);
    const reactions=(raw.beatReactions||['shockwave']).filter(r2=>VALID_BEATS.includes(r2)).slice(0,4);
    const cpX=Math.min(0.9,Math.max(0.1,parseFloat(raw.centerpieceX)||0.5));
    const cpY=Math.min(0.9,Math.max(0.1,parseFloat(raw.centerpieceY)||0.5));
    const theme={scene,label:raw.label||'',splashDesc:raw.splashDesc||'',palette:Array.isArray(raw.palette)&&raw.palette.length===4?raw.palette:['#ff006e','#8338ec','#06ffd8','#ffbe0b'],bgColor:raw.bgColor||'#000010',centerpiece:cp,centerpieceScale:Math.min(1.5,Math.max(0,parseFloat(raw.centerpieceScale)||0.5)),centerpieceX:cpX,centerpieceY:cpY,centerpieceBehavior:VALID_BEH.includes(raw.centerpieceBehavior)?raw.centerpieceBehavior:'rotate',beatReactions:reactions.length?reactions:['shockwave'],sceneSpeed:Math.min(3,Math.max(0.3,parseFloat(raw.sceneSpeed)||1)),sceneIntensity:Math.min(1,Math.max(0,parseFloat(raw.sceneIntensity)||0.7)),energy:Math.min(1,Math.max(0,parseFloat(raw.energy)||0.5)),chaos:Math.min(1,Math.max(0,parseFloat(raw.chaos)||0.4))};
    recordScene(scene);recordCP(cp);
    aiCache[tid]=theme;applyTheme(name,artist,theme);
  }catch(e){console.error('[AI]',e);}
}
function applyTheme(name,artist,theme){
  document.getElementById('sceneTag').textContent=(theme.scene||'—').replace(/_/g,' ')+' — '+(theme.label||'');
  transition(name,artist,theme);
}

// ═══ SPOTIFY API ═══
async function spGet(ep){
  const r=await fetch('https://api.spotify.com/v1/'+ep,{headers:{Authorization:'Bearer '+token}});
  if(r.status===401){const nt=await refreshAT();if(nt)token=nt;else{logout();return null;}}
  if(!r.ok||r.status===204)return null;
  try{return await r.json()}catch{return null}
}
async function poll(){
  const d=await spGet('me/player/currently-playing');
  if(!d?.item)return;
  const tr=d.item,tid=tr.id;
  MS.progress=d.progress_ms||0;MS.duration=tr.duration_ms||180000;MS.analysisStart=Date.now()-MS.progress;
  MS.beatInterval=500;MS.energy=d.is_playing?0.6:0.3;
  if(tid!==lastTid){
    lastTid=tid;
    document.getElementById('trackName').textContent=tr.name;
    document.getElementById('artistName').textContent=tr.artists.map(a=>a.name).join(', ');
    const art=tr.album?.images?.[0]?.url;if(art)document.getElementById('albumArt').src=art;
    loadTheme(tid,tr.name,tr.artists.map(a=>a.name).join(', '),tr.artists.map(a=>a.id),tr.explicit,tr.duration_ms);
  }
}

// ═══ INIT ═══
document.getElementById('loginBtn').addEventListener('click',doLogin);
document.getElementById('fsBtn').addEventListener('click',()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen();document.getElementById('fsBtn').textContent='✕ EXIT';}else{document.exitFullscreen();document.getElementById('fsBtn').textContent='⛶ FS';}});

async function init(){
  const p=new URLSearchParams(location.search),code=p.get('code');
  console.log('[auth] init — code='+(code?'present':'none'));
  if(p.get('error')){showErr('Spotify error: '+p.get('error'));return;}
  if(code){
    history.replaceState({},document.title,'/');
    token=await exchToken(code);
    if(!token)return;
  }else{
    token=getAT();
    if(!token)token=await refreshAT();
    console.log('[auth] stored token: '+(token?'found':'none'));
  }
  if(token){
    document.getElementById('login').style.display='none';
    document.getElementById('ui').style.display='block';
    document.getElementById('fsBtn').style.display='block';
    initScene();
    poll();
    setInterval(poll,5000);
  }
}
init();
</script>
</body>
</html>
